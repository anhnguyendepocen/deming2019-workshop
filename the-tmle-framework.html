<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 The TMLE Framework | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="generator" content="bookdown 0.16.2 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 The TMLE Framework | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/deming2019-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="github-repo" content="tlverse/deming2019-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 The TMLE Framework | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  

<meta name="author" content="Rachael Phillips, Nima Hejazi, Jeremy Coyle, Ivana Malenica, Alan Hubbard, Mark van der Laan" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="super-ensemble-machine-learning.html"/>
<link rel="next" href="stochastic-treatment-regimes.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.8/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Deming Conference 2019 Targeted Learning Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i>Important links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#half-day-tutorial-9a-12p-on-december-4-2019"><i class="fa fa-check"></i>Half-Day Tutorial – 9A-12P on December 4, 2019</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#day-short-course-8a-5p-on-december-5-6-2019"><i class="fa fa-check"></i>2-Day Short Course – 8A-5P on December 5-6, 2019</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contents"><i class="fa fa-check"></i>Contents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors-and-authors"><i class="fa fa-check"></i>About the instructors and authors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="tlverse.html"><a href="tlverse.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="tlverse.html"><a href="tlverse.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="tlverse.html"><a href="tlverse.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="tlverse.html"><a href="tlverse.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="tlverse.html"><a href="tlverse.html#installtlverse"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> The Roadmap of Statistical Learning</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#the-observed-data-and-statistical-model"><i class="fa fa-check"></i><b>2.1</b> The Observed Data and Statistical Model</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>2.2</b> The Causal Model</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>2.3</b> The Parameter of Interest</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>2.4</b> Identifiability</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#estimation-targeted-maximum-likelihood-estimation"><i class="fa fa-check"></i><b>2.5</b> Estimation: Targeted Maximum Likelihood Estimation</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>2.6</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>3</b> Datasets</a><ul>
<li class="chapter" data-level="3.1" data-path="data.html"><a href="data.html#ist"><i class="fa fa-check"></i><b>3.1</b> International Stroke Trial Example Dataset</a></li>
<li class="chapter" data-level="3.2" data-path="data.html"><a href="data.html#wash"><i class="fa fa-check"></i><b>3.2</b> WASH Benefits Example Dataset</a></li>
<li class="chapter" data-level="3.3" data-path="data.html"><a href="data.html#vet"><i class="fa fa-check"></i><b>3.3</b> Veterans’ Administration Lung Cancer Trial Dataset</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html"><i class="fa fa-check"></i><b>4</b> Super (Ensemble Machine) Learning</a><ul>
<li class="chapter" data-level="4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="4.1.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#super-learning"><i class="fa fa-check"></i><b>4.1.1</b> Super Learning</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#review-of-the-super-learner"><i class="fa fa-check"></i>Review of the Super Learner</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3-microwave-dinner-implementation"><i class="fa fa-check"></i><b>4.2</b> <code>sl3</code> “Microwave Dinner” Implementation</a><ul>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#wash-benefits-study-example"><i class="fa fa-check"></i>WASH Benefits Study Example</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#load-the-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load the necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#define-the-machine-learning-task"><i class="fa fa-check"></i>1. Define the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#make-a-super-learner"><i class="fa fa-check"></i>2. Make a super learner</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#train-the-super-learner-on-the-machine-learning-task"><i class="fa fa-check"></i>3. Train the super learner on the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#obtain-predicted-values"><i class="fa fa-check"></i>4. Obtain predicted values</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#extensions"><i class="fa fa-check"></i><b>4.3</b> Extensions</a><ul>
<li class="chapter" data-level="4.3.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>4.3.1</b> Cross-validated Super Learner</a></li>
<li class="chapter" data-level="4.3.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#variable-importance-measures-with-sl3"><i class="fa fa-check"></i><b>4.3.2</b> Variable Importance Measures with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise"><i class="fa fa-check"></i><b>4.4</b> Exercise</a><ul>
<li class="chapter" data-level="4.4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3ex"><i class="fa fa-check"></i><b>4.4.1</b> Predicting Myocardial Infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#summary"><i class="fa fa-check"></i><b>4.5</b> Summary</a><ul>
<li class="chapter" data-level="4.5.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise-solutions"><i class="fa fa-check"></i><b>4.5.1</b> Exercise Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html"><i class="fa fa-check"></i><b>5</b> The TMLE Framework</a><ul>
<li class="chapter" data-level="5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#substitution-estimators"><i class="fa fa-check"></i><b>5.1.1</b> Substitution Estimators</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle"><i class="fa fa-check"></i><b>5.1.2</b> TMLE</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#inference-1"><i class="fa fa-check"></i><b>5.1.3</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#learning-objectives-1"><i class="fa fa-check"></i><b>5.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#easy-bake-example-tmle3-for-ate"><i class="fa fa-check"></i><b>5.3</b> Easy-Bake Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#load-the-data"><i class="fa fa-check"></i>0. Load the Data</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-variable-roles"><i class="fa fa-check"></i>1. Define the variable roles</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#create-a-spec-object"><i class="fa fa-check"></i>2. Create a “Spec” Object</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-relevant-super-learners"><i class="fa fa-check"></i>3. Define the Relevant Super Learners</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit-the-tmle"><i class="fa fa-check"></i>4. Fit the TMLE</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i>5. Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3-components"><i class="fa fa-check"></i><b>5.4</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="5.4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3_task"><i class="fa fa-check"></i><b>5.4.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>5.4.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="5.4.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>5.4.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="5.4.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>5.4.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="5.4.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>5.4.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>5.5</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="5.5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#delta-method"><i class="fa fa-check"></i><b>5.5.1</b> Delta Method</a></li>
<li class="chapter" data-level="5.5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit"><i class="fa fa-check"></i><b>5.5.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#stratified-effect-estimates"><i class="fa fa-check"></i><b>5.6</b> Stratified Effect Estimates</a></li>
<li class="chapter" data-level="5.7" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#exercise-1"><i class="fa fa-check"></i><b>5.7</b> Exercise</a></li>
<li class="chapter" data-level="5.8" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#summary-1"><i class="fa fa-check"></i><b>5.8</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html"><i class="fa fa-check"></i><b>6</b> Stochastic Treatment Regimes</a><ul>
<li class="chapter" data-level="6.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#learning-objectives-2"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#introduction-2"><i class="fa fa-check"></i><b>6.2</b> Introduction</a></li>
<li class="chapter" data-level="6.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions"><i class="fa fa-check"></i><b>6.3</b> Stochastic Interventions</a><ul>
<li class="chapter" data-level="6.3.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#identifying-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.1</b> Identifying the Causal Effect of a Stochastic Intervention</a></li>
<li class="chapter" data-level="6.3.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#interpreting-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.2</b> Interpreting the Causal Effect of a Stochastic Intervention</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#estimating-the-causal-effect-of-a-stochastic-intervention-with-tmle3shift"><i class="fa fa-check"></i><b>6.4</b> Estimating the Causal Effect of a Stochastic Intervention with <code>tmle3shift</code></a><ul>
<li class="chapter" data-level="6.4.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#simulate-data"><i class="fa fa-check"></i><b>6.4.1</b> Simulate Data</a></li>
<li class="chapter" data-level="6.4.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-interventions-effects"><i class="fa fa-check"></i><b>6.4.2</b> Targeted Estimation of Stochastic Interventions Effects</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions-over-a-grid-of-counterfactual-shifts"><i class="fa fa-check"></i><b>6.5</b> Stochastic Interventions over a Grid of Counterfactual Shifts</a><ul>
<li class="chapter" data-level="6.5.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#initializing-vimshift-through-its-tmle3_spec"><i class="fa fa-check"></i><b>6.5.1</b> Initializing <code>vimshift</code> through its <code>tmle3_Spec</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-intervention-effects"><i class="fa fa-check"></i><b>6.5.2</b> Targeted Estimation of Stochastic Intervention Effects</a></li>
<li class="chapter" data-level="6.5.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#inference-with-marginal-structural-models"><i class="fa fa-check"></i><b>6.5.3</b> Inference with Marginal Structural Models</a></li>
<li class="chapter" data-level="6.5.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#directly-targeting-the-msm-parameter-beta"><i class="fa fa-check"></i><b>6.5.4</b> Directly Targeting the MSM Parameter <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="6.5.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#example-with-the-wash-benefits-data"><i class="fa fa-check"></i><b>6.5.5</b> Example with the WASH Benefits Data</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#exercise-2"><i class="fa fa-check"></i><b>6.6</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html"><i class="fa fa-check"></i><b>7</b> One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="7.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#learning-objectives-3"><i class="fa fa-check"></i><b>7.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#introduction-3"><i class="fa fa-check"></i><b>7.2</b> Introduction</a><ul>
<li class="chapter" data-level="7.2.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#existing-methods-for-observational-survival-analysis"><i class="fa fa-check"></i><b>7.2.1</b> Existing Methods for Observational Survival Analysis</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#using-moss-for-one-step-tmle-for-time-to-event-outcomes"><i class="fa fa-check"></i><b>7.3</b> Using <code>MOSS</code> for One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#load-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#specify-right-censored-survival-data-arguments"><i class="fa fa-check"></i>1. Specify right-censored survival data arguments</a></li>
<li><a href="one-step-tmle-for-time-to-event-outcomes.html#obtain-initial-estimates-with-superlearner-r-package">2. Obtain initial estimates with <code>SuperLearner</code> <code>R</code> package</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#perform-tmle-adjustment-of-the-initial-conditional-survival-estimate"><i class="fa fa-check"></i>3. Perform TMLE adjustment of the initial conditional survival estimate</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#compute-standard-error-estimates-for-simultaneous-inference"><i class="fa fa-check"></i>4. Compute standard error estimates for simultaneous inference</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>8</b> A Primer on the <code>R6</code> Class System</a><ul>
<li class="chapter" data-level="8.1" data-path="r6.html"><a href="r6.html#classes-fields-and-methods"><i class="fa fa-check"></i><b>8.1</b> Classes, Fields, and Methods</a></li>
<li class="chapter" data-level="8.2" data-path="r6.html"><a href="r6.html#object-oriented-programming-python-and-r"><i class="fa fa-check"></i><b>8.2</b> Object Oriented Programming: <code>Python</code> and <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the <code>tlverse</code> Software Ecosystem</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="the-tmle-framework" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> The TMLE Framework</h1>
<p>Based on the <a href="https://github.com/tlverse/tmle3"><code>tmle3</code> <code>R</code> package</a>.</p>
<p>Updated: 2019-12-05</p>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">5.1</span> Introduction</h2>
<p>The first step in the estimation procedure is an initial estimate of the
data-generating distribution, or the relevant part of this distribution that is
needed to evaluate the target parameter. For this initial estimation, we use the
super learner <span class="citation">(van der Laan, Polley, and Hubbard <a href="#ref-vdl2007super">2007</a>)</span>, as described in the previous section.</p>
<p>With the initial estimate of relevant parts of the data-generating distribution
necessary to evaluate the target parameter, we are ready to construct the TMLE!</p>
<div id="substitution-estimators" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Substitution Estimators</h3>
<ul>
<li>Beyond a fit of the prediction function, one might also want to estimate more
targeted parameters specific to certain scientific questions.</li>
<li>The approach is to plug into the estimand of interest estimates of the
relevant distributions.</li>
<li>Sometimes, we can use simple empirical distributions, but averaging some
function over the observations (e.g., giving weight <span class="math inline">\(1/n\)</span> for all
observations).</li>
<li>Other parts of the distribution, like conditional means or probabilities, the
estimate will require some sort of smoothing due to the curse of
dimensionality.</li>
</ul>
<p>We give one example using an example of the average treatment effect (see
above):</p>
<ul>
<li><span class="math inline">\(\Psi(P_0) = \Psi(Q_0) = \mathbb{E}_0 \big[\mathbb{E}_0[Y \mid A = 1, W] - \mathbb{E}_0[Y \mid A = 0, W]\big]\)</span>, where <span class="math inline">\(Q_0\)</span> represents both the
distribution of <span class="math inline">\(Y \mid A,W\)</span> and distribution of <span class="math inline">\(W\)</span>.</li>
<li>Let <span class="math inline">\(\bar{Q}_0(A,W) \equiv \mathbb{E}_0(Y \mid A,W)\)</span> and <span class="math inline">\(Q_{0,W}(w) = P_0 (W=w)\)</span>, then
<span class="math display">\[
\Psi(Q_0) = \sum_w \{ \bar{Q}_0(1,w)-\bar{Q}_0(0,w)\} Q_{0,W}(w)
\]</span></li>
<li>The <strong>Substitution Estimator</strong> plugs in the empirical distribution (weight
<span class="math inline">\(1/n\)</span> for each observation) for <span class="math inline">\(Q_{0,W}(W_i)\)</span>, and some estimate of the
regression of <span class="math inline">\(Y\)</span> on <span class="math inline">\((A,W)\)</span> (say SL fit):
<span class="math display">\[
 \Psi(Q_n) = \frac{1}{n} \sum_{i=1}^n  \{ \bar{Q}_n(1,W_i)-\bar{Q}_n(0,W_i)\}
 \]</span></li>
<li>Thus, it becomes the average of the differences in predictions from the fit
keeping the observed <span class="math inline">\(W\)</span>, but first replacing <span class="math inline">\(A=1\)</span> and then the same but all
<span class="math inline">\(A=0\)</span>.</li>
</ul>
</div>
<div id="tmle" class="section level3">
<h3><span class="header-section-number">5.1.2</span> TMLE</h3>
<ul>
<li>Though using SL over an arbitrary parametric regression is an improvement,
it’s not sufficient to have the properties of an estimator one needs for
rigorous inference.</li>
<li>Because the variance-bias trade-off in the SL is focused on the prediction
model, it can, for instance, under-fit portions of the distributions that are
critical for estimating the parameter of interest, <span class="math inline">\(\Psi(P_0)\)</span>.</li>
<li>TMLE keeps the benefits of substitution estimators (it is one), but augments
the original estimates to correct for this issue and also results in an
asymptotically linear (and thus normally-distributed) estimator with
consistent Wald-style confidence intervals.</li>
<li>Produces a well-defined, unbiased, efficient substitution estimator of target
parameters of a data-generating distribution.</li>
<li>Updates an initial (super learner) estimate of the relevant part of the
data-generating distribution possibly using an estimate of a nuisance
parameter (like the model of intervention given covariates).</li>
<li>Removes asymptotic residual bias of initial estimator for the target
parameter, if it uses a consistent estimator of <span class="math inline">\(g_0\)</span>.</li>
<li>If initial estimator was consistent for the target parameter, the additional
fitting of the data in the targeting step may remove finite sample bias, and
preserves consistency property of the initial estimator.</li>
<li>If the initial estimator and the estimator of <span class="math inline">\(g_0\)</span> are both consistent, then
it is also asymptotically efficient according to semi-parametric statistical
model efficiency theory.</li>
<li>Thus, every effort is made to achieve minimal bias and the asymptotic
semi-parametric efficiency bound for the variance.</li>
</ul>
<embed src="img/misc/TMLEimage.pdf" width=" extwidth" style="display: block; margin: auto;" type="application/pdf" />
<ul>
<li>There are different types of TMLE, sometimes for the same set of parameters,
but below is an example of the algorithm for estimating the ATE.</li>
<li>In this case, one can present the estimator as:</li>
</ul>
<p><span class="math display">\[
 \Psi(Q^{\star}_n) = \frac{1}{n} \sum_{i=1}^n \{ \bar{Q}^{\star}_n(1,W_i) -
 \bar{Q}^{\star}_n(0,W_i)\}
 \]</span>
where <span class="math inline">\(\bar{Q}^{\star}_n(A,W)\)</span> is the TMLE augmented estimate.
<span class="math inline">\(f(\bar{Q}^{\star}_n(A,W)) = f(\bar{Q}_n(A,W)) + \epsilon_n \cdot h_n(A,W)\)</span>,
where <span class="math inline">\(f(\cdot)\)</span> is the appropriate link function (e.g., logit), <span class="math inline">\(\epsilon_n\)</span>
is an estimated coefficient and <span class="math inline">\(h_n(A,W)\)</span> is a “clever covariate”.</p>
<ul>
<li>In this case, <span class="math inline">\(h_n(A,W) = \frac{A}{g_n(W)}-\frac{1-A}{1-g_n(W)}\)</span>, with
<span class="math inline">\(g_n(W) = \mathbb{P}(A=1 \mid W)\)</span> being the estimated (also by SL) propensity score,
so the estimator depends both on initial SL fit of the outcome regression
(<span class="math inline">\(\bar{Q}_0\)</span>) and an SL fit of the propensity score (<span class="math inline">\(g_n\)</span>).</li>
<li>There are further robust augmentations that are used in <code>tlverse</code>, such as an
added layer of cross-validation to avoid over-fitting bias (CV-TMLE), and so
called methods that can more robustly estimated several parameters
simultaneously (e.g., the points on a survival curve).</li>
</ul>
</div>
<div id="inference-1" class="section level3">
<h3><span class="header-section-number">5.1.3</span> Inference</h3>
<ul>
<li>The estimators we discuss are <strong>asymptotically linear</strong>, meaning that the
difference in the estimate <span class="math inline">\(\Psi(P_n)\)</span> and the true parameter (<span class="math inline">\(\Psi(P_0)\)</span>)
can be represented in first order by a i.i.d. sum:
<span class="math display">\[\begin{equation}\label{eqn:IC}
\Psi(P_n) - \Psi(P_0) = \frac{1}{n} \sum_{i=1}^n IC(O_i; \nu) + o_p(1/\sqrt{n})
\end{equation}\]</span></li>
</ul>
<p>where <span class="math inline">\(IC(O_i; \nu)\)</span> (the influence curve or function) is a function of the data
and possibly other nuisance parameters <span class="math inline">\(\nu\)</span>. Importantly, such estimators have
mean-zero Gaussian limiting distributions; thus, in the univariate case, one has
that
<span class="math display">\[\begin{equation}\label{eqn:limit_dist}
  \sqrt{n}(\Psi(P_n) - \Psi(P_0)) \xrightarrow[]{D}N(0,\mathbb{V}IC(O_i;\nu)),
\end{equation}\]</span>
so that inference for the estimator of interest may be obtained in terms of the
influence function. For this simple case, a 95% confidence interval may be
derived as:
<span class="math display">\[\begin{equation}\label{eqn:CI}
  \Psi(P^{\star}_n) \pm z_{1 - \frac{\alpha}{2}} \sqrt{\frac{\hat{\sigma}^2}{n}},
\end{equation}\]</span>
where <span class="math inline">\(SE=\sqrt{\frac{\hat{\sigma}^2}{n}}\)</span> and <span class="math inline">\(\hat{\sigma}^2\)</span> is the sample
variance of the estimated IC’s: <span class="math inline">\(IC(O; \hat{\nu})\)</span>. One can use the functional
delta method to derive the influence curve if a parameter of interest may be
written as a function of other asymptotically linear estimators.</p>
<ul>
<li>Thus, we can derive robust inference for parameters that are estimated by
fitting complex, machine learning algorithms and these methods are
computationally quick (do not rely on re-sampling based methods like the
bootstrap).</li>
</ul>
</div>
</div>
<div id="learning-objectives-1" class="section level2">
<h2><span class="header-section-number">5.2</span> Learning Objectives</h2>
<ol style="list-style-type: decimal">
<li>Use <code>tmle3</code> to estimate an Average Treatment Effect (ATE)</li>
<li>Understand <code>tmle3</code> “Specs”</li>
<li>Fit <code>tmle3</code> for a custom set of parameters</li>
<li>Use the delta method to estimate transformations of parameters</li>
</ol>
</div>
<div id="easy-bake-example-tmle3-for-ate" class="section level2">
<h2><span class="header-section-number">5.3</span> Easy-Bake Example: <code>tmle3</code> for ATE</h2>
<p>We’ll illustrate the most basic use of TMLE using the IST example data
introduced earlier and estimating an Average Treatment Effect (ATE).</p>
<p>As a reminder, the ATE is identified with the following statistical parameter
(under assumptions): <span class="math inline">\(ATE = \mathbb{E}_0(Y(1)-Y(0)) = \mathbb{E}_0\left(\mathbb{E}_0[Y \mid A=1,W]-\mathbb{E}_0[Y \mid A=0,W] \right)\)</span></p>
<p>This Easy-Bake implementation consists of the following steps:</p>
<ol start="0" style="list-style-type: decimal">
<li>Load the necessary libraries and data</li>
<li>Define the variable roles</li>
<li>Create a “Spec” object</li>
<li>Define the super learners</li>
<li>Fit the TMLE</li>
<li>Evaluate the TMLE estimates</li>
</ol>
<div id="load-the-data" class="section level3 unnumbered">
<h3>0. Load the Data</h3>
<p>We’ll use the same WASH Benefits data as the earlier chapters:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="kw">library</span>(tmle3)</a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="kw">library</span>(sl3)</a>
<a class="sourceLine" id="cb41-4" data-line-number="4">ist_data &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="kw">read.csv</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/deming2019-workshop/master/data/ist_sample.csv&quot;</span>))</a></code></pre></div>
</div>
<div id="define-the-variable-roles" class="section level3 unnumbered">
<h3>1. Define the variable roles</h3>
<p>We’ll use the common <span class="math inline">\(W\)</span> (covariates), <span class="math inline">\(A\)</span> (treatment/intervention), <span class="math inline">\(Y\)</span>
(outcome) data structure. <code>tmle3</code> needs to know what variables in the dataset
correspond to each of these roles. We use a list of character vectors to tell
it. We call this a <strong>“Node List”</strong> as it corresponds to the nodes in a Directed
Acyclic Graph (DAG), a way of displaying causal relationships between variables.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb42-2" data-line-number="2">  <span class="dt">W =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb42-3" data-line-number="3">    <span class="st">&quot;RXHEP&quot;</span>, <span class="st">&quot;REGION&quot;</span>, <span class="st">&quot;RDELAY&quot;</span>, <span class="st">&quot;RCONSC&quot;</span>, <span class="st">&quot;SEX&quot;</span>, <span class="st">&quot;AGE&quot;</span>, <span class="st">&quot;RSLEEP&quot;</span>, <span class="st">&quot;RVISINF&quot;</span>,</a>
<a class="sourceLine" id="cb42-4" data-line-number="4">    <span class="st">&quot;RCT&quot;</span>, <span class="st">&quot;RATRIAL&quot;</span>, <span class="st">&quot;RASP3&quot;</span>, <span class="st">&quot;MISSING_RATRIAL_RASP3&quot;</span>, <span class="st">&quot;RHEP24&quot;</span>, </a>
<a class="sourceLine" id="cb42-5" data-line-number="5">    <span class="st">&quot;MISSING_RHEP24&quot;</span>, <span class="st">&quot;RSBP&quot;</span>, <span class="st">&quot;RDEF1&quot;</span>, <span class="st">&quot;RDEF2&quot;</span>, <span class="st">&quot;RDEF3&quot;</span>, <span class="st">&quot;RDEF4&quot;</span>, <span class="st">&quot;RDEF5&quot;</span>,</a>
<a class="sourceLine" id="cb42-6" data-line-number="6">    <span class="st">&quot;RDEF6&quot;</span>, <span class="st">&quot;RDEF7&quot;</span>, <span class="st">&quot;RDEF8&quot;</span>, <span class="st">&quot;STYPE&quot;</span></a>
<a class="sourceLine" id="cb42-7" data-line-number="7">    ),</a>
<a class="sourceLine" id="cb42-8" data-line-number="8">  <span class="dt">A =</span> <span class="st">&quot;RXASP&quot;</span>,</a>
<a class="sourceLine" id="cb42-9" data-line-number="9">  <span class="dt">Y =</span> <span class="st">&quot;DRSISC&quot;</span></a>
<a class="sourceLine" id="cb42-10" data-line-number="10">)</a></code></pre></div>
<div id="handling-missingness" class="section level4 unnumbered">
<h4>Handling Missingness</h4>
<p>Currently, missingness in <code>tlverse</code> is handled in a fairly simple way:</p>
<ul>
<li>Missing covariates are median (for continuous) or mode (for discrete)
imputed, and additional covariates indicating imputation are generated</li>
<li>Observations missing treatment variables are excluded.</li>
<li>We implement an IPCW-TMLE to more efficiently handle missingness in the
outcome variables.</li>
</ul>
<p>These steps are implemented in the <code>process_missing()</code> function in <code>tmle3</code>, and
are automatically handled in <code>sl3</code>. In this data, we already imputed missing
covariate values which were present in <code>RATRIAL</code>, <code>RASP3</code>, <code>RHEP24</code>; and we
created additional covariates indicating imputation <code>MISSING_RATRIAL_RASP3</code>,
<code>MISSING_RHEP24</code>. The missingness was identical for <code>RATRIAL</code> and <code>RASP3</code>, so
we only needed to create one covariate indicating imputation for these two
variables.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">head</span>(ist_data)</a></code></pre></div>
<pre><code>   RDELAY RCONSC SEX AGE RSLEEP RATRIAL RCT RVISINF RHEP24 RASP3 RSBP RDEF1
1:     46      F   F  85      N       N   N       N      Y     N  150     N
2:     33      F   M  71      Y       Y   Y       Y      N     Y  180     Y
3:      6      D   M  88      N       Y   N       N      N     N  140     Y
4:      8      F   F  68      Y       N   Y       Y      N     N  118     Y
5:     13      F   M  60      N       N   Y       N      N     N  140     Y
6:     16      F   F  71      Y       N   Y       N      N     N  160     N
   RDEF2 RDEF3 RDEF4 RDEF5 RDEF6 RDEF7 RDEF8 STYPE RXHEP
1:     Y     N     N     N     N     N     N  PACS     N
2:     Y     Y     Y     Y     N     N     N  TACS     L
3:     Y     Y     C     C     C     C     C  PACS     N
4:     Y     N     N     N     N     N     N  LACS     M
5:     Y     Y     Y     N     N     Y     Y  POCS     N
6:     Y     N     N     N     N     N     N  PACS     N
                    REGION MISSING_RATRIAL_RASP3 MISSING_RHEP24 RXASP DRSISC
1: Europe and Central Asia                     0              0     0      0
2:   East Asia and Pacific                     0              0     0      0
3: Europe and Central Asia                     0              0     0      0
4: Europe and Central Asia                     0              0     0      0
5: Europe and Central Asia                     0              0     1      0
6: Europe and Central Asia                     0              0     1      0</code></pre>
</div>
</div>
<div id="create-a-spec-object" class="section level3 unnumbered">
<h3>2. Create a “Spec” Object</h3>
<p><code>tmle3</code> is general, and allows most components of the TMLE procedure to be
specified in a modular way. However, most end-users will not be interested in
manually specifying all of these components. Therefore, <code>tmle3</code> implements a
<code>tmle3_Spec</code> object that bundles a set of components into a <strong>specification</strong>
that, with minimal additional detail, can be run by an end-user.</p>
<p>We’ll start with using one of the specs, and then work our way down into the
internals of <code>tmle3</code>.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">ate_spec &lt;-<span class="st"> </span><span class="kw">tmle_ATE</span>(</a>
<a class="sourceLine" id="cb45-2" data-line-number="2">  <span class="dt">treatment_level =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb45-3" data-line-number="3">  <span class="dt">control_level =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4">)</a></code></pre></div>
</div>
<div id="define-the-relevant-super-learners" class="section level3 unnumbered">
<h3>3. Define the Relevant Super Learners</h3>
<p>Currently, the only other thing a user must define are the <code>sl3</code> learners used
to estimate the relevant factors of the likelihood: <span class="math inline">\(Q\)</span>, <span class="math inline">\(g\)</span>, and <span class="math inline">\(\Delta\)</span>.</p>
<p>This takes the form of a list of <code>sl3</code> learners, one for each likelihood factor
to be estimated with <code>sl3</code>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co"># choose base learners</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2">lrnr_mean &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_mean)</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">lrnr_glm &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_glm)</a>
<a class="sourceLine" id="cb46-4" data-line-number="4">lrnr_xgboost &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_xgboost)</a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="co"># default metalearner appropriate to data types</span></a>
<a class="sourceLine" id="cb46-6" data-line-number="6"></a>
<a class="sourceLine" id="cb46-7" data-line-number="7">sl_Y &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb46-8" data-line-number="8">  <span class="dt">learners =</span> <span class="kw">list</span>(lrnr_mean, lrnr_glm, lrnr_xgboost)</a>
<a class="sourceLine" id="cb46-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb46-10" data-line-number="10">sl_Delta &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb46-11" data-line-number="11">  <span class="dt">learners =</span> <span class="kw">list</span>(lrnr_mean, lrnr_glm, lrnr_xgboost)</a>
<a class="sourceLine" id="cb46-12" data-line-number="12">  )</a>
<a class="sourceLine" id="cb46-13" data-line-number="13">sl_A &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb46-14" data-line-number="14">  <span class="dt">learners =</span> <span class="kw">list</span>(lrnr_mean, lrnr_glm)</a>
<a class="sourceLine" id="cb46-15" data-line-number="15">  )</a>
<a class="sourceLine" id="cb46-16" data-line-number="16">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">A =</span> sl_A, <span class="dt">delta_Y =</span> sl_Delta, <span class="dt">Y =</span> sl_Y)</a></code></pre></div>
<p>Here, we use a super learner as defined in the previous <code>sl3</code> section. In the
future, we plan to include reasonable default learners.</p>
</div>
<div id="fit-the-tmle" class="section level3 unnumbered">
<h3>4. Fit the TMLE</h3>
<p>We now have everything we need to fit the tmle using <code>tmle3</code>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1">tmle_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(ate_spec, ist_data, node_list, learner_list)</a></code></pre></div>
</div>
<div id="evaluate-the-estimates" class="section level3 unnumbered">
<h3>5. Evaluate the Estimates</h3>
<p>We can see the summary results by printing the fit object. Alternatively, we
can extra results from the summary by indexing into it:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="kw">print</span>(tmle_fit)</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                      param     init_est     tmle_est
1:  ATE ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] -0.002183712 -0.004789243
            se       lower       upper psi_transformed lower_transformed
1: 0.004320523 -0.01325731 0.003678826    -0.004789243       -0.01325731
   upper_transformed
1:       0.003678826</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="co"># in most cases the transformation that&#39;s applied to tmle3 estimates and </span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="co"># inference (psi_transformed) is nothing -- it comes up for estimands like ORs, </span></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="co"># which are estimated on the log scale</span></a>
<a class="sourceLine" id="cb50-4" data-line-number="4">estimates &lt;-<span class="st"> </span>tmle_fit<span class="op">$</span>summary<span class="op">$</span>psi_transformed</a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="kw">print</span>(estimates)</a></code></pre></div>
<pre><code>[1] -0.004789243</code></pre>
</div>
</div>
<div id="tmle3-components" class="section level2">
<h2><span class="header-section-number">5.4</span> <code>tmle3</code> Components</h2>
<p>Now that we’ve successfully used a spec to obtain a TML estimate, let’s look
under the hood at the components. The spec has a number of functions that
generate the objects necessary to define and fit a TMLE.</p>
<div id="tmle3_task" class="section level3">
<h3><span class="header-section-number">5.4.1</span> <code>tmle3_task</code></h3>
<p>First is, a <code>tmle3_Task</code>, analogous to an <code>sl3_Task</code>, containing the data we’re
fitting the TMLE to, as well as an NPSEM generated from the <code>node_list</code> defined
above, describing the variables and their relationships.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">tmle_task &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_tmle_task</span>(ist_data, node_list)</a></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1">tmle_task<span class="op">$</span>npsem</a></code></pre></div>
<pre><code>$W
tmle3_Node: W
    Variables: RXHEP, REGION, RDELAY, RCONSC, SEX, AGE, RSLEEP, RVISINF, RCT, RATRIAL, RASP3, MISSING_RATRIAL_RASP3, RHEP24, MISSING_RHEP24, RSBP, RDEF1, RDEF2, RDEF3, RDEF4, RDEF5, RDEF6, RDEF7, RDEF8, STYPE
    Parents: 

$A
tmle3_Node: A
    Variables: RXASP
    Parents: W

$Y
tmle3_Node: Y
    Variables: DRSISC
    Parents: A, W

$delta_Y
tmle3_Node: delta_Y
    Variables: delta_Y
    Parents: A, W</code></pre>
</div>
<div id="initial-likelihood" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Initial Likelihood</h3>
<p>Next, is an object representing the likelihood, factorized according to the
NPSEM described above:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">initial_likelihood &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_initial_likelihood</span>(</a>
<a class="sourceLine" id="cb55-2" data-line-number="2">  tmle_task,</a>
<a class="sourceLine" id="cb55-3" data-line-number="3">  learner_list</a>
<a class="sourceLine" id="cb55-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb55-5" data-line-number="5"><span class="kw">print</span>(initial_likelihood)</a></code></pre></div>
<pre><code>W: Lf_emp
A: LF_fit
Y: LF_fit
delta_Y: LF_fit</code></pre>
<p>These components of the likelihood indicate how the factors were estimated: the
marginal distribution of <span class="math inline">\(W\)</span> was estimated using NPMLE, and the conditional
distributions of <span class="math inline">\(A\)</span>, <span class="math inline">\(\Delta\)</span>, and <span class="math inline">\(Y\)</span> were estimated using <code>sl3</code> fits (as
defined with the <code>learner_list</code>) above.</p>
<p>We can use this in tandem with the <code>tmle_task</code> object to obtain likelihood
estimates for each observation:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">initial_likelihood<span class="op">$</span><span class="kw">get_likelihoods</span>(tmle_task)</a></code></pre></div>
<pre><code>          W         A          Y   delta_Y
   1: 2e-04 0.4931489 0.01830207 0.9996849
   2: 2e-04 0.5322987 0.02620549 0.9996298
   3: 2e-04 0.4768974 0.01374835 0.9995944
   4: 2e-04 0.5162369 0.02242328 0.9995865
   5: 2e-04 0.5157461 0.01532110 0.9974412
  ---                                     
4996: 2e-04 0.4952086 0.01268525 0.9996025
4997: 2e-04 0.4930104 0.02619468 0.9985074
4998: 2e-04 0.4928078 0.01231529 0.9987709
4999: 2e-04 0.4790922 0.03180140 0.9993951
5000: 2e-04 0.4948690 0.01583199 0.9982467</code></pre>
<!-- TODO: make helper to get learners out of fit objects -->
</div>
<div id="targeted-likelihood-updater" class="section level3">
<h3><span class="header-section-number">5.4.3</span> Targeted Likelihood (updater)</h3>
<p>We also need to define a “Targeted Likelihood” object. This is a special type
of likelihood that is able to be updated using an <code>tmle3_Update</code> object. This
object defines the update strategy (e.g. submodel, loss function, CV-TMLE or
not, etc).</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">targeted_likelihood &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood)</a></code></pre></div>
<p>When constructing the targeted likelihood, you can specify different update
options. See the documentation for <code>tmle3_Update</code> for details of the different
options. For example, you can disable CV-TMLE (the default in <code>tmle3</code>) as
follows:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">targeted_likelihood_no_cv &lt;-</a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="st">  </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood,</a>
<a class="sourceLine" id="cb60-3" data-line-number="3">    <span class="dt">updater =</span> <span class="kw">list</span>(<span class="dt">cvtmle =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb60-4" data-line-number="4">  )</a></code></pre></div>
</div>
<div id="parameter-mapping" class="section level3">
<h3><span class="header-section-number">5.4.4</span> Parameter Mapping</h3>
<p>Finally, we need to define the parameters of interest. Here, the spec defines a
single parameter, the ATE. In the next section, we’ll see how to add additional
parameters.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">tmle_params &lt;-<span class="st"> </span>ate_spec<span class="op">$</span><span class="kw">make_params</span>(tmle_task, targeted_likelihood)</a>
<a class="sourceLine" id="cb61-2" data-line-number="2"><span class="kw">print</span>(tmle_params)</a></code></pre></div>
<pre><code>[[1]]
Param_ATE: ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}]</code></pre>
</div>
<div id="putting-it-all-together" class="section level3">
<h3><span class="header-section-number">5.4.5</span> Putting it all together</h3>
<p>Having used the spec to manually generate all these components, we can now
manually fit a <code>tmle3</code>:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">tmle_fit_manual &lt;-<span class="st"> </span><span class="kw">fit_tmle3</span>(</a>
<a class="sourceLine" id="cb63-2" data-line-number="2">  tmle_task, targeted_likelihood, tmle_params,</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">  targeted_likelihood<span class="op">$</span>updater</a>
<a class="sourceLine" id="cb63-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb63-5" data-line-number="5"><span class="kw">print</span>(tmle_fit_manual)</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                      param     init_est     tmle_est
1:  ATE ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] -0.002183462 -0.004798667
            se       lower      upper psi_transformed lower_transformed
1: 0.004313869 -0.01325369 0.00365636    -0.004798667       -0.01325369
   upper_transformed
1:        0.00365636</code></pre>
<p>The result is equivalent to fitting using the <code>tmle3</code> function as above.</p>
</div>
</div>
<div id="fitting-tmle3-with-multiple-parameters" class="section level2">
<h2><span class="header-section-number">5.5</span> Fitting <code>tmle3</code> with multiple parameters</h2>
<p>Above, we fit a <code>tmle3</code> with just one parameter. <code>tmle3</code> also supports fitting
multiple parameters simultaneously. To illustrate this, we’ll use the
<code>tmle_TSM_all</code> spec:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1">tsm_spec &lt;-<span class="st"> </span><span class="kw">tmle_TSM_all</span>()</a>
<a class="sourceLine" id="cb65-2" data-line-number="2">targeted_likelihood &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(initial_likelihood)</a>
<a class="sourceLine" id="cb65-3" data-line-number="3">all_tsm_params &lt;-<span class="st"> </span>tsm_spec<span class="op">$</span><span class="kw">make_params</span>(tmle_task, targeted_likelihood)</a>
<a class="sourceLine" id="cb65-4" data-line-number="4"><span class="kw">print</span>(all_tsm_params)</a></code></pre></div>
<pre><code>[[1]]
Param_TSM: E[Y_{A=0, delta_Y=1}]

[[2]]
Param_TSM: E[Y_{A=1, delta_Y=1}]</code></pre>
<p>This spec generates a Treatment Specific Mean (TSM) for each level of the
exposure variable. Note that we must first generate a new targeted likelihood,
as the old one was targeted to the ATE. However, we can recycle the initial
likelihood we fit above, saving us a super learner step.</p>
<div id="delta-method" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Delta Method</h3>
<p>We can also define parameters based on Delta Method Transformations of other
parameters. For instance, we can estimate a ATE using the delta method and two
of the above TSM parameters:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">ate_param &lt;-<span class="st"> </span><span class="kw">define_param</span>(</a>
<a class="sourceLine" id="cb67-2" data-line-number="2">  Param_delta, targeted_likelihood,</a>
<a class="sourceLine" id="cb67-3" data-line-number="3">  delta_param_ATE,</a>
<a class="sourceLine" id="cb67-4" data-line-number="4">  <span class="kw">list</span>(all_tsm_params[[<span class="dv">1</span>]], all_tsm_params[[<span class="dv">2</span>]])</a>
<a class="sourceLine" id="cb67-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb67-6" data-line-number="6"><span class="kw">print</span>(ate_param)</a></code></pre></div>
<pre><code>Param_delta: E[Y_{A=1, delta_Y=1}] - E[Y_{A=0, delta_Y=1}]</code></pre>
<p>This can similarly be used to estimate other derived parameters like Relative
Risks, and Population Attributable Risks.</p>
</div>
<div id="fit" class="section level3">
<h3><span class="header-section-number">5.5.2</span> Fit</h3>
<p>We can now fit a TMLE simultaneously for all TSM parameters, as well as the
above defined ATE parameter</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">all_params &lt;-<span class="st"> </span><span class="kw">c</span>(all_tsm_params, ate_param)</a>
<a class="sourceLine" id="cb69-2" data-line-number="2">tmle_fit_multiparam &lt;-<span class="st"> </span><span class="kw">fit_tmle3</span>(</a>
<a class="sourceLine" id="cb69-3" data-line-number="3">  tmle_task, targeted_likelihood, all_params,</a>
<a class="sourceLine" id="cb69-4" data-line-number="4">  targeted_likelihood<span class="op">$</span>updater</a>
<a class="sourceLine" id="cb69-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb69-6" data-line-number="6"><span class="kw">print</span>(tmle_fit_multiparam)</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type                                         param     init_est     tmle_est
1:  TSM                         E[Y_{A=0, delta_Y=1}]  0.022007860  0.026008394
2:  TSM                         E[Y_{A=1, delta_Y=1}]  0.019824399  0.021186741
3:  ATE E[Y_{A=1, delta_Y=1}] - E[Y_{A=0, delta_Y=1}] -0.002183462 -0.004821652
            se       lower       upper psi_transformed lower_transformed
1: 0.003189488  0.01975711 0.032259675     0.026008394        0.01975711
2: 0.002903174  0.01549663 0.026876857     0.021186741        0.01549663
3: 0.004315252 -0.01327939 0.003636086    -0.004821652       -0.01327939
   upper_transformed
1:       0.032259675
2:       0.026876857
3:       0.003636086</code></pre>
</div>
</div>
<div id="stratified-effect-estimates" class="section level2">
<h2><span class="header-section-number">5.6</span> Stratified Effect Estimates</h2>
<p>TMLE can also be applied to estimate effects in in strata of a baseline
covariate. The tmle_stratified spec makes it easy to extend an existing spec
with stratification.</p>
<p>For instance, we can estimate strata specific ATEs as follows:
<span class="math inline">\(ATE = \mathbb{E}_0(Y(1)-Y(0) \mid V=v ) = \mathbb{E}_0\left(\mathbb{E}_0[Y \mid A=1,W]-\mathbb{E}_0[Y \mid A=0,W] \mid V=v \right)\)</span></p>
<p>For example, we can stratify the above ATE spec to estimate the ATE in strata of
country region:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">stratified_ate_spec &lt;-<span class="st"> </span><span class="kw">tmle_stratified</span>(ate_spec, <span class="st">&quot;REGION&quot;</span>)</a>
<a class="sourceLine" id="cb71-2" data-line-number="2">stratified_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(stratified_ate_spec, ist_data, node_list, learner_list)</a></code></pre></div>
<pre><code>Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;
Error in xgboost::xgb.DMatrix(Xmat) : 
  REAL() can only be applied to a &#39;numeric&#39;, not a &#39;logical&#39;</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="kw">print</span>(stratified_fit)</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
             type
1:            ATE
2: stratified ATE
3: stratified ATE
4: stratified ATE
5: stratified ATE
6: stratified ATE
7: stratified ATE
8: stratified ATE
                                                                       param
1:                                ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}]
2:    ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=Europe and Central Asia
3:      ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=East Asia and Pacific
4: ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=Middle East &amp; North Africa
5:  ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=Latin America &amp; Caribbean
6:                 ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=South Asia
7:              ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=North America
8:         ATE[Y_{A=2, delta_Y=1}-Y_{A=1, delta_Y=1}] | V=Sub-Saharan Africa
        init_est      tmle_est           se        lower       upper
1: -2.183748e-03 -0.0047173479 0.0043052812 -0.013155544 0.003720848
2: -2.181735e-03 -0.0043570420 0.0046255759 -0.013423004 0.004708920
3: -2.780636e-03  0.0043900815 0.0207525243 -0.036284119 0.045064282
4: -3.393405e-05 -0.0001042741 0.0009770074 -0.002019173 0.001810625
5: -2.613295e-03 -0.0257579555 0.0231701216 -0.071170559 0.019654648
6: -7.060910e-06  0.0014983530 0.0013862748 -0.001218696 0.004215402
7: -2.851834e-03 -0.0084873346 0.0478456103 -0.102263008 0.085288338
8: -4.579117e-03 -0.0928775761 0.1026262009 -0.294021234 0.108266082
   psi_transformed lower_transformed upper_transformed
1:   -0.0047173479      -0.013155544       0.003720848
2:   -0.0043570420      -0.013423004       0.004708920
3:    0.0043900815      -0.036284119       0.045064282
4:   -0.0001042741      -0.002019173       0.001810625
5:   -0.0257579555      -0.071170559       0.019654648
6:    0.0014983530      -0.001218696       0.004215402
7:   -0.0084873346      -0.102263008       0.085288338
8:   -0.0928775761      -0.294021234       0.108266082</code></pre>
<p>This TMLE is consistent for both the marginal ATE as well as the ATEs in strata
of <span class="math inline">\(V\)</span>. For continuous <span class="math inline">\(V\)</span>, this could be extended using a working Marginal
Structural Model (MSM), although that has not yet been implemented in <code>tmle3</code>.</p>
</div>
<div id="exercise-1" class="section level2">
<h2><span class="header-section-number">5.7</span> Exercise</h2>
<p>Follow the steps below to estimate an ATE using a simplified version of data
from the Collaborative Perinatal Project (CPP), available in the <code>sl3</code> package.
We define a binary intervention variable, <code>parity01</code> – an indicator of having
one or more children before the current child and a binary outcome, <code>haz01</code> –
an indicator of having an above average height for age.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="co"># load the data set</span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="kw">data</span>(cpp)</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">cpp &lt;-<span class="st"> </span>cpp[<span class="op">!</span><span class="kw">is.na</span>(cpp[, <span class="st">&quot;haz&quot;</span>]), ]</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">cpp<span class="op">$</span>parity01 &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cpp<span class="op">$</span>parity <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb75-5" data-line-number="5">cpp[<span class="kw">is.na</span>(cpp)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb75-6" data-line-number="6">cpp<span class="op">$</span>haz01 &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cpp<span class="op">$</span>haz <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
<!--
We're interested in using this simplified data to estimate an Average Treatment
Effect (ATE):
$$\Psi(P_0) = E_0(E_0[Y|A=1,W]-E_0[Y|A=0,W])$$
The purely statistical (non-causal) parameter can be interpreted as the average
of the difference in means across the strata for $W$, and only requires the
positivity assumption, that the conditional treatment assignment probabilities
are positive for each possible $w: P_0(A=1 \mid W=w) > 0$ and
$P_0(A=0 \mid W=w) > 0$ for each possible $w$.
To interpret this parameter as causal, specifically the causal risk difference
$E_0Y_1-E_0Y_0$, then we would also need to make the randomization assumption
stating that $A$ is independent of the counterfactuals $(Y_0,Y_1)$ within
strata of $W$. This assumption might have been included in the original SCM
$\mathcal{M}^F$, but, if one knows there are unmeasured confounders, then the
model $\mathcal{M}^{F\*}$ would be more restrictive by enforcing this "known
to be wrong" randomization assumption. Still, this assumption does not change
the statistical model $\mathcal{M}$, and as a consequence, it does not affect
the estimation problem either. Thus, the theorem's that establish desirable
properties of the TMLE, still hold even when this non-testable randomization
assumption is violated.
We proceed with implementing a targeted minimum loss-based estimator (TMLE),
an efficient substitution estimator which is not only asymptotically
consistent, asymptotically normally distributed, and asymptotically efficient,
but also tailored to have robust finite sample performance.
-->
<ol style="list-style-type: decimal">
<li>Define the variable roles <span class="math inline">\((W,A,Y)\)</span> by creating a list of these nodes.
Include the following baseline covariates in <span class="math inline">\(W\)</span>: <code>apgar1</code>, <code>apgar5</code>,
<code>gagebrth</code>, <code>mage</code>, <code>meducyrs</code>, <code>sexn</code>. Both <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span> are specified
above.</li>
<li>Define a <code>tmle3_Spec</code> object for the ATE, <code>tmle_ATE()</code>.</li>
<li>Using the same base learning libraries defined above, specify <code>sl3</code> base
learners for estimation of <span class="math inline">\(Q = E(Y|A,Y)\)</span> and <span class="math inline">\(g=P(A|W)\)</span>.</li>
<li>Define the metalearner like below</li>
</ol>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp,</a>
<a class="sourceLine" id="cb76-2" data-line-number="2">  <span class="dt">loss_function =</span> loss_loglik_binomial,</a>
<a class="sourceLine" id="cb76-3" data-line-number="3">  <span class="dt">learner_function =</span> metalearner_logistic_binomial</a>
<a class="sourceLine" id="cb76-4" data-line-number="4">)</a></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Define one super learner for estimating <span class="math inline">\(Q\)</span> and another for estimating <span class="math inline">\(g\)</span>.
Use the metalearner above for both <span class="math inline">\(Q\)</span> and <span class="math inline">\(g\)</span> super learners.</li>
<li>Create a list of the two super learners defined in Step 5 and call this
object <code>learner_list</code>. The list names should be <code>A</code> (defining the super
learner for estimating <span class="math inline">\(g\)</span>) and <code>Y</code> (defining the super learner for
estimating <span class="math inline">\(Q\)</span>).</li>
<li>Fit the tmle with the <code>tmle3</code> function by specifying (1) the <code>tmle3_Spec</code>,
which we defined in Step 2; (2) the data; (3) the list of nodes, which we
specified in Step 1; and (4) the list of super learners for estimating <span class="math inline">\(g\)</span>
and <span class="math inline">\(Q\)</span>, which we defined in Step 6. <em>Note</em>: Like before, you will need to
make a data copy to deal with <code>data.table</code> weirdness
(<code>cpp2 &lt;- data.table::copy(cpp)</code>) and use <code>cpp2</code> as the data.</li>
<li>Interpret the <code>tmle3</code> fit both causally and statistically.</li>
</ol>
</div>
<div id="summary-1" class="section level2">
<h2><span class="header-section-number">5.8</span> Summary</h2>
<ul>
<li><code>tmle3</code> is a general purpose framework for generating TML estimates.</li>
<li>The easiest way to use <code>tmle3</code> is to use a predefined spec, allowing you to
just fill in the blanks for the data, variable roles, and <code>sl3</code> learners.</li>
<li>Digging under the hood allows users to specify a wide range of TMLEs.</li>
<li>In the next sections, we’ll see how this framework can be used to estimate
more modern parameters such as the effect under optimal treatments and shift<br />
interventions.</li>
</ul>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="super-ensemble-machine-learning.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="stochastic-treatment-regimes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/deming2019-workshop/edit/master/06-tmle3.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
