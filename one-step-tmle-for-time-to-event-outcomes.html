<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="generator" content="bookdown 0.16.5 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/deming2019-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="github-repo" content="tlverse/deming2019-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  

<meta name="author" content="Rachael Phillips, Nima Hejazi, Jeremy Coyle, Ivana Malenica, Alan Hubbard, Mark van der Laan" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="the-tmle-framework.html"/>
<link rel="next" href="r6.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Deming Conference 2019 Targeted Learning Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i>Important links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#half-day-tutorial-9a-12p-on-december-4-2019"><i class="fa fa-check"></i>Half-Day Tutorial – 9A-12P on December 4, 2019</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#day-short-course-8a-5p-on-december-5-6-2019"><i class="fa fa-check"></i>2-Day Short Course – 8A-5P on December 5-6, 2019</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contents"><i class="fa fa-check"></i>Contents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors-and-authors"><i class="fa fa-check"></i>About the instructors and authors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="tlverse.html"><a href="tlverse.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="tlverse.html"><a href="tlverse.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="tlverse.html"><a href="tlverse.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="tlverse.html"><a href="tlverse.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="tlverse.html"><a href="tlverse.html#installtlverse"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> The Roadmap of Statistical Learning</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#the-observed-data-and-statistical-model"><i class="fa fa-check"></i><b>2.1</b> The Observed Data and Statistical Model</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>2.2</b> The Causal Model</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>2.3</b> The Parameter of Interest</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>2.4</b> Identifiability</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#estimation-targeted-maximum-likelihood-estimation"><i class="fa fa-check"></i><b>2.5</b> Estimation: Targeted Maximum Likelihood Estimation</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>2.6</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>3</b> Datasets</a><ul>
<li class="chapter" data-level="3.1" data-path="data.html"><a href="data.html#ist"><i class="fa fa-check"></i><b>3.1</b> International Stroke Trial Example Dataset</a></li>
<li class="chapter" data-level="3.2" data-path="data.html"><a href="data.html#wash"><i class="fa fa-check"></i><b>3.2</b> WASH Benefits Example Dataset</a></li>
<li class="chapter" data-level="3.3" data-path="data.html"><a href="data.html#vet"><i class="fa fa-check"></i><b>3.3</b> Veterans’ Administration Lung Cancer Trial Dataset</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html"><i class="fa fa-check"></i><b>4</b> Super (Ensemble Machine) Learning</a><ul>
<li class="chapter" data-level="4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="4.1.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#super-learning"><i class="fa fa-check"></i><b>4.1.1</b> Super Learning</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#review-of-the-super-learner"><i class="fa fa-check"></i>Review of the Super Learner</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3-microwave-dinner-implementation"><i class="fa fa-check"></i><b>4.2</b> <code>sl3</code> “Microwave Dinner” Implementation</a><ul>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#international-stroke-trial-example"><i class="fa fa-check"></i>International Stroke Trial Example</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#load-the-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load the necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#define-the-machine-learning-task"><i class="fa fa-check"></i>1. Define the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#make-a-super-learner"><i class="fa fa-check"></i>2. Make a super learner</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#train-the-super-learner-on-the-machine-learning-task"><i class="fa fa-check"></i>3. Train the super learner on the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#obtain-predicted-values"><i class="fa fa-check"></i>4. Obtain predicted values</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#extensions"><i class="fa fa-check"></i><b>4.3</b> Extensions</a><ul>
<li class="chapter" data-level="4.3.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>4.3.1</b> Cross-validated Super Learner</a></li>
<li class="chapter" data-level="4.3.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#variable-importance-measures-with-sl3"><i class="fa fa-check"></i><b>4.3.2</b> Variable Importance Measures with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise"><i class="fa fa-check"></i><b>4.4</b> Exercise</a><ul>
<li class="chapter" data-level="4.4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3ex"><i class="fa fa-check"></i><b>4.4.1</b> Predicting Myocardial Infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#summary"><i class="fa fa-check"></i><b>4.5</b> Summary</a><ul>
<li class="chapter" data-level="4.5.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise-solutions"><i class="fa fa-check"></i><b>4.5.1</b> Exercise Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html"><i class="fa fa-check"></i><b>5</b> The TMLE Framework</a><ul>
<li class="chapter" data-level="5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#substitution-estimators"><i class="fa fa-check"></i><b>5.1.1</b> Substitution Estimators</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle"><i class="fa fa-check"></i><b>5.1.2</b> TMLE</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#inference-1"><i class="fa fa-check"></i><b>5.1.3</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#learning-objectives-1"><i class="fa fa-check"></i><b>5.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#easy-bake-example-tmle3-for-ate"><i class="fa fa-check"></i><b>5.3</b> Easy-Bake Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#load-the-data"><i class="fa fa-check"></i>0. Load the Data</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-variable-roles"><i class="fa fa-check"></i>1. Define the variable roles</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#create-a-spec-object"><i class="fa fa-check"></i>2. Create a “Spec” Object</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-relevant-super-learners"><i class="fa fa-check"></i>3. Define the Relevant Super Learners</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit-the-tmle"><i class="fa fa-check"></i>4. Fit the TMLE</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i>5. Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3-components"><i class="fa fa-check"></i><b>5.4</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="5.4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3_task"><i class="fa fa-check"></i><b>5.4.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>5.4.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="5.4.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>5.4.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="5.4.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>5.4.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="5.4.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>5.4.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>5.5</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="5.5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#delta-method"><i class="fa fa-check"></i><b>5.5.1</b> Delta Method</a></li>
<li class="chapter" data-level="5.5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit"><i class="fa fa-check"></i><b>5.5.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#stratified-effect-estimates"><i class="fa fa-check"></i><b>5.6</b> Stratified Effect Estimates</a></li>
<li class="chapter" data-level="5.7" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#exercise-1"><i class="fa fa-check"></i><b>5.7</b> Exercise</a></li>
<li class="chapter" data-level="5.8" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#summary-1"><i class="fa fa-check"></i><b>5.8</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html"><i class="fa fa-check"></i><b>6</b> One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="6.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#learning-objectives-2"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#introduction-2"><i class="fa fa-check"></i><b>6.2</b> Introduction</a><ul>
<li class="chapter" data-level="6.2.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#existing-methods-for-observational-survival-analysis"><i class="fa fa-check"></i><b>6.2.1</b> Existing Methods for Observational Survival Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#using-moss-for-one-step-tmle-for-time-to-event-outcomes"><i class="fa fa-check"></i><b>6.3</b> Using <code>MOSS</code> for One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#load-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#specify-right-censored-survival-data-arguments"><i class="fa fa-check"></i>1. Specify right-censored survival data arguments</a></li>
<li><a href="one-step-tmle-for-time-to-event-outcomes.html#obtain-initial-estimates-with-superlearner-r-package">2. Obtain initial estimates with <code>SuperLearner</code> <code>R</code> package</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#perform-tmle-adjustment-of-the-initial-conditional-survival-estimate"><i class="fa fa-check"></i>3. Perform TMLE adjustment of the initial conditional survival estimate</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#compute-standard-error-estimates-for-simultaneous-inference"><i class="fa fa-check"></i>4. Compute standard error estimates for simultaneous inference</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#learning-objectives-3"><i class="fa fa-check"></i><b>6.4</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.5" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#introduction-to-optimal-individualized-interventions"><i class="fa fa-check"></i><b>6.5</b> Introduction to Optimal Individualized Interventions</a><ul>
<li class="chapter" data-level="6.5.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#data-structure-and-notation"><i class="fa fa-check"></i><b>6.5.1</b> Data Structure and Notation</a></li>
<li class="chapter" data-level="6.5.2" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#defining-the-causal-effect-of-an-optimal-individualized-intervention"><i class="fa fa-check"></i><b>6.5.2</b> Defining the Causal Effect of an Optimal Individualized Intervention</a></li>
<li class="chapter" data-level="6.5.3" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#why-cv-tmle"><i class="fa fa-check"></i><b>6.5.3</b> Why CV-TMLE?</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#optimal-itr-with-a-binary-treatment"><i class="fa fa-check"></i><b>6.6</b> Optimal ITR with a Binary Treatment</a><ul>
<li class="chapter" data-level="6.6.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-a-binary-treatment"><i class="fa fa-check"></i><b>6.6.1</b> Evaluating the Causal Effect of an Optimal ITR with a Binary Treatment</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#optimal-itr-with-a-categorical-treatment"><i class="fa fa-check"></i><b>6.7</b> Optimal ITR with a Categorical Treatment</a><ul>
<li class="chapter" data-level="6.7.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-a-categorical-treatment"><i class="fa fa-check"></i><b>6.7.1</b> Evaluating the Causal Effect of an Optimal ITR with a Categorical Treatment</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#extensions-to-causal-effect-of-an-oit"><i class="fa fa-check"></i><b>6.8</b> Extensions to Causal Effect of an OIT</a><ul>
<li class="chapter" data-level="6.8.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#simpler-rules"><i class="fa fa-check"></i><b>6.8.1</b> Simpler Rules</a></li>
<li class="chapter" data-level="6.8.2" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#realistic-optimal-individual-regimes"><i class="fa fa-check"></i><b>6.8.2</b> Realistic Optimal Individual Regimes</a></li>
<li class="chapter" data-level="6.8.3" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#variable-importance-analysis"><i class="fa fa-check"></i><b>6.8.3</b> Variable Importance Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#exercise-2"><i class="fa fa-check"></i><b>6.9</b> Exercise</a><ul>
<li class="chapter" data-level="6.9.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#causal-effect-of-the-optimal-itr-in-the-wash-benefits-trial"><i class="fa fa-check"></i><b>6.9.1</b> Causal Effect of the Optimal ITR in the WASH Benefits Trial</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#summary-2"><i class="fa fa-check"></i><b>6.10</b> Summary</a><ul>
<li class="chapter" data-level="6.10.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#exercise-solutions-1"><i class="fa fa-check"></i><b>6.10.1</b> Exercise Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>7</b> A Primer on the <code>R6</code> Class System</a><ul>
<li class="chapter" data-level="7.1" data-path="r6.html"><a href="r6.html#classes-fields-and-methods"><i class="fa fa-check"></i><b>7.1</b> Classes, Fields, and Methods</a></li>
<li class="chapter" data-level="7.2" data-path="r6.html"><a href="r6.html#object-oriented-programming-python-and-r"><i class="fa fa-check"></i><b>7.2</b> Object Oriented Programming: <code>Python</code> and <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the <code>tlverse</code> Software Ecosystem</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="one-step-tmle-for-time-to-event-outcomes" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> One-Step TMLE for Time-to-Event Outcomes</h1>
<p>Based on the <a href="https://github.com/wilsoncai1992/MOSS"><code>MOSS</code> <code>R</code> package</a>
by <em>Wilson Cai and Mark van der Laan</em>.</p>
<p>Updated: 2019-12-06</p>
<div id="learning-objectives-2" class="section level2">
<h2><span class="header-section-number">6.1</span> Learning Objectives</h2>
<ol style="list-style-type: decimal">
<li>Format right-censored survival data for <code>MOSS</code>.</li>
<li>Fit a SuperLearner initial estimate of the conditional survival function of
failure, conditional survival function of censoring and the propensity scores
(<code>initial_sl_fit</code>).</li>
<li>Calculate the TMLE adjustment of the conditional survival fit
(<code>MOSS_hazard</code>).</li>
<li>Formulate a simultaneous confidence band for the estimated conditional
survival across a range of time-points (<code>compute_simultaneous_ci</code>).</li>
</ol>
</div>
<div id="introduction-2" class="section level2">
<h2><span class="header-section-number">6.2</span> Introduction</h2>
<p>In this section, we explore the <code>MOSS</code> <code>R</code> package. This software performs
ensemble machine learning with the <a href="https://cran.r-project.org/web/packages/SuperLearner/index.html"><code>SuperLearner</code> <code>R</code>
package</a> and
One-Step Targeted Maximum Likelihood Estimation (TMLE) to estimate
counterfactual marginal survival functions and the Average Treatment Effect
(ATE) on survival probabilities, while non-parametrically adjusting for measured
confounding. This one-step TMLE can be executed via recursion in small local
updates, and creates a doubly robust and semi-parametrically efficient
estimator. Simultaneous confidence bands of the entire curve are also
available for inference.</p>
<div id="existing-methods-for-observational-survival-analysis" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Existing Methods for Observational Survival Analysis</h3>
<p>To facilitate comparison with other estimation procedures, the following
additional estimators are also included in the <code>MOSS</code> <code>R</code> package:</p>
<ul>
<li>Inverse Censoring Probability Weighted (IPCW) estimator, which re-weights the
observed data by the inverse of the product of the propensity score and
censoring probability before applying a standard estimation method
<span class="citation">(Rotnitzky and Robins <a href="#ref-rotnitzky2014inverse">2014</a>)</span>.</li>
<li>Estimating Equation (EE) estimator, which improves IPCW by adding the sample
mean of the efficient influence curve and is a locally efficient and double
robust <span class="citation">(Hubbard, Van Der Laan, and Robins <a href="#ref-hubbard2000nonparametric">2000</a>)</span>.</li>
</ul>
<p><strong>TMLE works well to improve the statistical efficiency of EE</strong>
Like EE, TMLE is also doubly robust and locally efficient. In contrast to these
two methods, TMLE performs an adjustment on the estimate of the relevant part
of the data-generating distribution before applying the parameter mapping and
thus always respects the parameter space (probabilities falling inside [0,1]),
a so-called substitution/plug-in estimator. As a result, is more robust to
outliers and sparsity than non-substitution estimators.</p>
<p><strong>Motivating one-step TMLE: monotonic survival curve</strong>
EE and TMLE utilize efficiency theory derived for univariate parameters, making
estimation of the survival curve a collection of univariate survival probability
estimators. This procedure can lead to a survival curve that is not
monotonically decreasing. The one-step TMLE implemented in <code>MOSS</code> targets the
survival curve <em>as a whole</em> and thus ensures monotonicity, while preserving the
desirable performance of the point-wise TMLE <span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>.</p>
</div>
</div>
<div id="using-moss-for-one-step-tmle-for-time-to-event-outcomes" class="section level2">
<h2><span class="header-section-number">6.3</span> Using <code>MOSS</code> for One-Step TMLE for Time-to-Event Outcomes</h2>
<p><code>MOSS</code> implementation consists of the following steps:</p>
<ol start="0" style="list-style-type: decimal">
<li>Load the necessary libraries and data.</li>
<li>Specify the right-censored survival data arguments.</li>
<li>Estimate the (1) conditional survival function of failure event, (2)
conditional survival function of censoring event, and (3) propensity score
with the <code>SuperLearner</code> <code>R</code> package.</li>
<li>Perform TMLE adjustment of the initial conditional survival fit.</li>
<li>Compute standard error estimates for simultaneous inference.</li>
</ol>
<div id="load-necessary-libraries-and-data" class="section level3 unnumbered">
<h3>0. Load necessary libraries and data</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="kw">library</span>(MOSS)</a>
<a class="sourceLine" id="cb77-2" data-line-number="2"></a>
<a class="sourceLine" id="cb77-3" data-line-number="3">vet_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/deming2019-workshop/master/data/veteran.csv&quot;</span>)</a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="kw">head</span>(vet_data)</a></code></pre></div>
<pre><code>  X trt celltype time status karno diagtime age prior
1 1   1 squamous   72      1    60        7  69     0
2 2   1 squamous  411      1    70        5  64    10
3 3   1 squamous  228      1    60        3  38     0
4 4   1 squamous  126      1    60        9  63    10
5 5   1 squamous  118      1    70       11  65    10
6 6   1 squamous   10      1    20        5  49     0</code></pre>
<p>The variables in <code>vet_data</code> are
* <code>trt</code>: treatment type (1 = standard, 2 = test),
* <code>celltype</code>: histological type of the tumor,
* <code>time</code>: time to death or censoring in days,
* <code>status</code>: censoring status,
* <code>karno</code>: Karnofsky performance score that describes overall patient status at
the beginning of the study (100 = good),
* <code>diagtime</code>: months from diagnosis to randomization,
* <code>age</code>: age of patient in years, and
* <code>prior</code>: prior therapy (0 = no, 10 = yes).</p>
</div>
<div id="specify-right-censored-survival-data-arguments" class="section level3 unnumbered">
<h3>1. Specify right-censored survival data arguments</h3>
<p>The following variables need to be specified from the data so they can
subsequently be used as required arguments for <code>MOSS</code> functions:</p>
<ul>
<li><code>W</code>: dataframe of baseline covariates <span class="math inline">\(W\)</span>.</li>
<li><code>A</code>: binary treatment vector <span class="math inline">\(A\)</span>.</li>
<li><code>T_tilde</code>: time-to-event vector <span class="math inline">\(\tilde{T} = \min(T, C)\)</span>.</li>
<li><code>Delta</code>: censoring indicator vector <span class="math inline">\(\Delta = I(T \leq C)\)</span>.</li>
<li><code>t_max</code>: the maximum time to estimate the survival probabilities.</li>
</ul>
<p>We can specify these variables with our observed <code>vet_data</code>.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">T_tilde &lt;-<span class="st"> </span>vet_data<span class="op">$</span>time</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">Delta &lt;-<span class="st"> </span>vet_data<span class="op">$</span>status</a>
<a class="sourceLine" id="cb79-3" data-line-number="3">A &lt;-<span class="st"> </span>vet_data<span class="op">$</span>trt</a>
<a class="sourceLine" id="cb79-4" data-line-number="4">W &lt;-<span class="st"> </span>vet_data[, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">9</span>)]</a>
<a class="sourceLine" id="cb79-5" data-line-number="5">t_max &lt;-<span class="st"> </span><span class="kw">max</span>(T_tilde)</a></code></pre></div>
</div>
<div id="obtain-initial-estimates-with-superlearner-r-package" class="section level3 unnumbered">
<h3>2. Obtain initial estimates with <code>SuperLearner</code> <code>R</code> package</h3>
<p>We will use the <code>initial_sl_fit()</code> function to specify the data (as we
defined it above) and the <code>SuperLearner</code> library for initial estimation of each
of the following components of the likelihood:</p>
<ol style="list-style-type: decimal">
<li>conditional survival function of failure event given treatment and
confounders,</li>
<li>conditional survival function for censoring event given treatment and
confounders, and</li>
<li>propensity score of treatment given confounders.</li>
</ol>
<p>We are forgetting one component of the likelihood that requires estimation: the
joint distribution of confounders! In <code>MOSS</code> this estimation is done for us
under the hood, and we do not use the <code>SuperLearner</code>. Do you recall why we do
not use the <code>SuperLearner</code> to estimate the joint distribution of confounders
nonparametrically?</p>
<p>The conditional survival functions are estimated by first estimating the
conditional hazard, and then transforming into the conditional survival
function. For a thorough explanation of these procedure see Section 3 from
<span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>. Currently, <code>MOSS</code> requires the user to do this one-to-one
tranformation from the conditional hazard to the conditional survival
probabilities by calling the <code>hazard_to_survival()</code> method. We will address
this later on.</p>
<p>Back to <code>initial_sl_fit()</code> – we have the option to specify the following
arguments in addition to the required data arguments.</p>
<ul>
<li><code>sl_failure</code>: SuperLearner library for failure event hazard, default =
c(“SL.glm”)</li>
<li><code>sl_censoring</code>: SuperLearner library for censoring event hazard, default =
c(“SL.glm”)</li>
<li><code>sl_treatment</code>: SuperLearner library for propensity score, default =
c(“SL.glm”)</li>
<li><code>gtol</code>: treshold for truncating propensity scores, default = 0.001)</li>
</ul>
<p>It is highly recommended that you specify a more complex library than the
default. The SuperLearner library arguments take a vector of strings
corresponding to learners available in the <code>SuperLearner</code> <code>R</code> package:
<a href="https://github.com/ecpolley/SuperLearner/tree/master/R" class="uri">https://github.com/ecpolley/SuperLearner/tree/master/R</a>.</p>
<p>We do not review the <code>SuperLearner</code> <code>R</code> package in these workshops, but a handy
tutorial crafted a few years ago by our colleague Chris Kennedy is freely
available: <a href="https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html">Guide to
SuperLearner</a>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co"># recall treatment was randomized</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2">SL.ranger.faster =<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">  <span class="kw">SL.ranger</span>(..., <span class="dt">num.trees =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb80-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb80-5" data-line-number="5">sl_lib_decent &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SL.mean&quot;</span>, <span class="st">&quot;SL.glm&quot;</span>, <span class="st">&quot;SL.step.forward&quot;</span>, <span class="st">&quot;SL.bayesglm&quot;</span>, </a>
<a class="sourceLine" id="cb80-6" data-line-number="6">                   <span class="st">&quot;SL.ranger.faster&quot;</span>, <span class="st">&quot;SL.gam&quot;</span>)</a>
<a class="sourceLine" id="cb80-7" data-line-number="7"></a>
<a class="sourceLine" id="cb80-8" data-line-number="8">initial_fit &lt;-<span class="st"> </span><span class="kw">initial_sl_fit</span>(T_tilde, Delta, A, W, t_max, </a>
<a class="sourceLine" id="cb80-9" data-line-number="9">                              <span class="dt">sl_censoring =</span> sl_lib_decent, </a>
<a class="sourceLine" id="cb80-10" data-line-number="10">                              <span class="dt">sl_failure =</span> sl_lib_decent)</a>
<a class="sourceLine" id="cb80-11" data-line-number="11"></a>
<a class="sourceLine" id="cb80-12" data-line-number="12"><span class="kw">names</span>(initial_fit)</a></code></pre></div>
<pre><code>[1] &quot;density_failure_1&quot; &quot;density_failure_0&quot; &quot;density_censor_1&quot; 
[4] &quot;density_censor_0&quot;  &quot;g1W&quot;              </code></pre>
<p>The <code>initial_fit</code> object contains the fitted conditional densities for the
failure events (<code>density_failure_1</code> for test treatment group,
<code>density_failure_0</code> for standard treatment group), censoring events
(<code>density_censor_1</code> and <code>density_censor_0</code> for test treatment and standard
treatment groups, respectively), and propensity scores (a vector <code>g1W</code>).</p>
<p>The <code>density_failure_1</code> and <code>density_failure_0</code> both need to go through the
<code>hazard_to_survival</code> method which populates the <code>survival</code> attribute of the
object.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span><span class="op">$</span><span class="kw">hazard_to_survival</span>()</a></code></pre></div>
<pre><code>&lt;survival_curve&gt;
  Public:
    ci: function (A, T_tilde, Delta, density_failure, density_censor, 
    clone: function (deep = FALSE) 
    create_ggplot_df: function (W = NULL) 
    display: function (type, W = NULL) 
    hazard: 0.0105086868901744 0.00890512674560573 0.010332023348463 ...
    hazard_to_pdf: function () 
    hazard_to_survival: function () 
    initialize: function (t, hazard = NULL, survival = NULL, pdf = NULL) 
    n: function () 
    pdf: NULL
    pdf_to_hazard: function () 
    pdf_to_survival: function () 
    survival: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  ...
    survival_to_hazard: function () 
    survival_to_pdf: function () 
    t: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ...</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span><span class="op">$</span><span class="kw">hazard_to_survival</span>()</a></code></pre></div>
<pre><code>&lt;survival_curve&gt;
  Public:
    ci: function (A, T_tilde, Delta, density_failure, density_censor, 
    clone: function (deep = FALSE) 
    create_ggplot_df: function (W = NULL) 
    display: function (type, W = NULL) 
    hazard: 0.0105086868901744 0.00890512674560573 0.010332023348463 ...
    hazard_to_pdf: function () 
    hazard_to_survival: function () 
    initialize: function (t, hazard = NULL, survival = NULL, pdf = NULL) 
    n: function () 
    pdf: NULL
    pdf_to_hazard: function () 
    pdf_to_survival: function () 
    survival: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  ...
    survival_to_hazard: function () 
    survival_to_pdf: function () 
    t: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ...</code></pre>
</div>
<div id="perform-tmle-adjustment-of-the-initial-conditional-survival-estimate" class="section level3 unnumbered">
<h3>3. Perform TMLE adjustment of the initial conditional survival estimate</h3>
<p>The one-step TMLE is carried out by many local least favorable submodels (LLFMs)
(performed via logistic regressions) with small step sizes. The one-step TMLE
updates in small steps locally along LLFM, ensuring that the direction of the
update is optimal around the current probability density. This procedure
permits updates to the conditional hazard for all points on the survival curve
(or any high-dimensional parameter in general), so that the conditional hazard
can be transformed into a monotone survival curve after the algorithm.</p>
<p>At this point we are nearly ready to update the hazard using this constrained
step size update. The only additional argument we need to define is</p>
<ul>
<li><code>k_grid</code>: the vector of interested time points for estimation of the
conditional survival probability.</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">k_grid &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">max</span>(T_tilde)</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span><span class="op">$</span>t &lt;-<span class="st"> </span>k_grid</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span><span class="op">$</span>t &lt;-<span class="st"> </span>k_grid</a></code></pre></div>
<p>We perform the TMLE adjustment of the initial conditional survival estimate by
first creating a <code>MOSS_hazard</code> or <code>MOSS_hazard_ate</code> object and then calling
the <code>iterate_onestep()</code> method for this object. <code>MOSS_hazard</code> and
<code>MOSS_hazard_ate</code> correspond to different estimators:</p>
<ul>
<li><code>MOSS_hazard</code>: one-step TMLE of the treatment-specific survival curve, and</li>
<li><code>MOSS_hazard_ate</code>: one-step TMLE of ATE on survival probabilities</li>
</ul>
<p><strong>One-step TMLE of the Treatment-Specific Survival</strong></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="co"># estimate survival curve for standard treatment group</span></a>
<a class="sourceLine" id="cb87-2" data-line-number="2">hazard_fit_standardA &lt;-<span class="st"> </span>MOSS_hazard<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb87-3" data-line-number="3">  A,</a>
<a class="sourceLine" id="cb87-4" data-line-number="4">  T_tilde,</a>
<a class="sourceLine" id="cb87-5" data-line-number="5">  Delta,</a>
<a class="sourceLine" id="cb87-6" data-line-number="6">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb87-7" data-line-number="7">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb87-8" data-line-number="8">  <span class="dt">g1W =</span> initial_fit<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb87-9" data-line-number="9">  <span class="dt">A_intervene =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb87-10" data-line-number="10">  k_grid</a>
<a class="sourceLine" id="cb87-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb87-12" data-line-number="12">psi_standardA &lt;-<span class="st"> </span>hazard_fit_standardA<span class="op">$</span><span class="kw">iterate_onestep</span>()</a></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="co"># estimate survival curve for test treatment group</span></a>
<a class="sourceLine" id="cb88-2" data-line-number="2">hazard_fit_testA &lt;-<span class="st"> </span>MOSS_hazard<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb88-3" data-line-number="3">  A,</a>
<a class="sourceLine" id="cb88-4" data-line-number="4">  T_tilde,</a>
<a class="sourceLine" id="cb88-5" data-line-number="5">  Delta,</a>
<a class="sourceLine" id="cb88-6" data-line-number="6">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb88-7" data-line-number="7">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb88-8" data-line-number="8">  <span class="dt">g1W =</span> initial_fit<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb88-9" data-line-number="9">  <span class="dt">A_intervene =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb88-10" data-line-number="10">  k_grid</a>
<a class="sourceLine" id="cb88-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb88-12" data-line-number="12">psi_testA &lt;-<span class="st"> </span>hazard_fit_testA<span class="op">$</span><span class="kw">iterate_onestep</span>()</a></code></pre></div>
<p><strong>One-step TMLE of ATE on Survival</strong></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">hazard_fit_ate &lt;-<span class="st"> </span>MOSS_hazard_ate<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb89-2" data-line-number="2">  A,</a>
<a class="sourceLine" id="cb89-3" data-line-number="3">  T_tilde,</a>
<a class="sourceLine" id="cb89-4" data-line-number="4">  Delta,</a>
<a class="sourceLine" id="cb89-5" data-line-number="5">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb89-6" data-line-number="6">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb89-7" data-line-number="7">  <span class="dt">density_failure_0 =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb89-8" data-line-number="8">  <span class="dt">density_censor_0 =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb89-9" data-line-number="9">  initial_fit<span class="op">$</span>g1W</a>
<a class="sourceLine" id="cb89-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb89-11" data-line-number="11">psi_ate &lt;-<span class="st"> </span>hazard_fit_ate<span class="op">$</span><span class="kw">iterate_onestep</span>()</a>
<a class="sourceLine" id="cb89-12" data-line-number="12"><span class="kw">summary</span>(psi_ate)</a></code></pre></div>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0 </code></pre>
</div>
<div id="compute-standard-error-estimates-for-simultaneous-inference" class="section level3 unnumbered">
<h3>4. Compute standard error estimates for simultaneous inference</h3>
<p>After creating a vector of survival curve estimates by defining a new
<code>survival_curve</code> object, we will estimate the efficient influence curve
using the TML-estimates generated in the previous step and then generate a
simultaneous confidence band for the TML-estimates.</p>
<p>A simultaneous confidence interval achieves the desired coverage across many
points, unlike the traditional confidence interval which achieves the desired
coverage for one point. Thus, the standard error for simultaneous inference is
larger when demanding simultaneous coverage of the truth, and it directly
follows that simultaneous confidence intervals are wider. Simultaneous inference
is a multiple testing procedure which controls the family-wise error rate.</p>
<p>A 95% simultaneous confidence band for the TML-estimates is constructed in the
following manner:</p>
<ol style="list-style-type: decimal">
<li>Retain the TML-estimates of the probability of surviving up to or past each
time specified in <code>k_grid</code> that we generated in the previous step.</li>
<li>Compute the influence curve matrix for all times specified in <code>k_grid</code> using
these TMLEs, where each column is an a time in <code>k_grid</code> and each row
corresponds to a subject.</li>
<li>Calculate the correlation of the IC matrix.</li>
<li>Randomly draw many values from a multivariate Normal(0,Sigma) distribution
(e.g. <code>z &lt;- rmvnorm(1e6, mean = rep(0, length(k_grid)), sigma = cor(IC_matrix))</code>
), where sigma corresponds to what was generated in step 3.</li>
<li>Identify the row-wise maximum of the absolute value of each MVN value (e.g.
<code>z_abs &lt;-  apply(z, 1, function(x) max(abs(x)))</code>).</li>
<li>Using these maximum absolute values, calculate the 95th quantile of <code>z_abs</code>,
which is the standard error to use for simultaneous inference
(e.g. <code>z_95 &lt;- quantile(z_abs, .95)</code>)</li>
<li>Calculate the time-specific standard deviation of the influence functions
(e.g. <code>sd_IC_time1 &lt;- sd(IC_matrix[,1])*sqrt(n-1)/n</code>)</li>
<li>Calculate the time-specific simultaneous confidence intervals (e.g.
<code>lower_bound_time1 &lt;- est_time1 - z_95*sd_IC_time1</code>)</li>
</ol>
<p>The simultaneous inference for the TML-estimates are constructed based on
asymptotic linearity of the TMLE uniform in all points considered. Step 4
approximates the Guassian process, and step 5 calculates the supremum norm of
this process. The 0.95 quantile of the supremum norm of the Guassian process
calculated in step 6 (i.e. <code>z_95</code>) will converge as the sample size increases
and as the values drawn from the MVN (i.e. <code>1e6</code> used in step 4) increase.</p>
<p>See the manuscript accompanying the <code>MOSS</code> package for more details and
references on constructing simultaneous inference <span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="co"># estimate and obtain inference for survival curve for standard treatment group</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2">survival_standardA &lt;-<span class="st"> </span>survival_curve<span class="op">$</span><span class="kw">new</span>(<span class="dt">t =</span> k_grid, <span class="dt">survival =</span> psi_standardA)</a>
<a class="sourceLine" id="cb91-3" data-line-number="3">survival_curve_standardA &lt;-<span class="st"> </span><span class="kw">as.vector</span>(survival_standardA<span class="op">$</span>survival)</a>
<a class="sourceLine" id="cb91-4" data-line-number="4"></a>
<a class="sourceLine" id="cb91-5" data-line-number="5">eic_standardA &lt;-<span class="st"> </span>eic<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb91-6" data-line-number="6">  <span class="dt">A =</span> A,</a>
<a class="sourceLine" id="cb91-7" data-line-number="7">  <span class="dt">T_tilde =</span> T_tilde,</a>
<a class="sourceLine" id="cb91-8" data-line-number="8">  <span class="dt">Delta =</span> Delta,</a>
<a class="sourceLine" id="cb91-9" data-line-number="9">  <span class="dt">density_failure =</span> hazard_fit_standardA<span class="op">$</span>density_failure,</a>
<a class="sourceLine" id="cb91-10" data-line-number="10">  <span class="dt">density_censor =</span> hazard_fit_standardA<span class="op">$</span>density_censor,</a>
<a class="sourceLine" id="cb91-11" data-line-number="11">  <span class="dt">g1W =</span> hazard_fit_standardA<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb91-12" data-line-number="12">  <span class="dt">psi =</span> survival_curve_standardA,</a>
<a class="sourceLine" id="cb91-13" data-line-number="13">  <span class="dt">A_intervene =</span> hazard_fit_standardA<span class="op">$</span>A_intervene</a>
<a class="sourceLine" id="cb91-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb91-15" data-line-number="15">eic_matrix_standardA &lt;-<span class="st"> </span>eic_standardA<span class="op">$</span><span class="kw">all_t</span>(<span class="dt">k_grid =</span> k_grid)</a>
<a class="sourceLine" id="cb91-16" data-line-number="16">std_err_standardA &lt;-<span class="st"> </span><span class="kw">compute_simultaneous_ci</span>(eic_matrix_standardA)</a>
<a class="sourceLine" id="cb91-17" data-line-number="17">upper_bound_standardA &lt;-<span class="st"> </span>survival_curve_standardA <span class="op">+</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_standardA)</a>
<a class="sourceLine" id="cb91-18" data-line-number="18">lower_bound_standardA &lt;-<span class="st"> </span>survival_curve_standardA <span class="op">-</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_standardA)</a>
<a class="sourceLine" id="cb91-19" data-line-number="19"></a>
<a class="sourceLine" id="cb91-20" data-line-number="20">plotdf_standardA &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> k_grid, <span class="dt">est =</span> survival_curve_standardA, </a>
<a class="sourceLine" id="cb91-21" data-line-number="21">                               <span class="dt">upper =</span> upper_bound_standardA, </a>
<a class="sourceLine" id="cb91-22" data-line-number="22">                               <span class="dt">lower =</span> lower_bound_standardA, </a>
<a class="sourceLine" id="cb91-23" data-line-number="23">                               <span class="dt">type =</span> <span class="kw">rep</span>(<span class="st">&quot;standard&quot;</span>, <span class="kw">length</span>(k_grid)))</a>
<a class="sourceLine" id="cb91-24" data-line-number="24"></a>
<a class="sourceLine" id="cb91-25" data-line-number="25">plot_standardA &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> plotdf_standardA, <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> est)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb91-27" data-line-number="27"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> plotdf_standardA, <span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), </a>
<a class="sourceLine" id="cb91-28" data-line-number="28">              <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb91-29" data-line-number="29"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Treatment-Specific Survival Curves Among Standard Treatment Group in</span></a>
<a class="sourceLine" id="cb91-30" data-line-number="30"><span class="st">           Veterans’ Administration Lung Cancer Trial&quot;</span>)</a>
<a class="sourceLine" id="cb91-31" data-line-number="31">plot_standardA</a></code></pre></div>
<p><img src="deming2019_workshop_files/figure-html/moss-4-standard-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="co"># estimate and obtain inference for survival curve for test treatment group</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2">survival_testA &lt;-<span class="st"> </span>survival_curve<span class="op">$</span><span class="kw">new</span>(<span class="dt">t =</span> k_grid, <span class="dt">survival =</span> psi_testA)</a>
<a class="sourceLine" id="cb92-3" data-line-number="3">survival_curve_testA &lt;-<span class="st"> </span><span class="kw">as.vector</span>(survival_testA<span class="op">$</span>survival)</a>
<a class="sourceLine" id="cb92-4" data-line-number="4"></a>
<a class="sourceLine" id="cb92-5" data-line-number="5">eic_testA &lt;-<span class="st"> </span>eic<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb92-6" data-line-number="6">  <span class="dt">A =</span> A,</a>
<a class="sourceLine" id="cb92-7" data-line-number="7">  <span class="dt">T_tilde =</span> T_tilde,</a>
<a class="sourceLine" id="cb92-8" data-line-number="8">  <span class="dt">Delta =</span> Delta,</a>
<a class="sourceLine" id="cb92-9" data-line-number="9">  <span class="dt">density_failure =</span> hazard_fit_testA<span class="op">$</span>density_failure,</a>
<a class="sourceLine" id="cb92-10" data-line-number="10">  <span class="dt">density_censor =</span> hazard_fit_testA<span class="op">$</span>density_censor,</a>
<a class="sourceLine" id="cb92-11" data-line-number="11">  <span class="dt">g1W =</span> hazard_fit_testA<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb92-12" data-line-number="12">  <span class="dt">psi =</span> survival_curve_testA,</a>
<a class="sourceLine" id="cb92-13" data-line-number="13">  <span class="dt">A_intervene =</span> hazard_fit_testA<span class="op">$</span>A_intervene</a>
<a class="sourceLine" id="cb92-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb92-15" data-line-number="15">eic_matrix_testA &lt;-<span class="st"> </span>eic_testA<span class="op">$</span><span class="kw">all_t</span>(<span class="dt">k_grid =</span> k_grid)</a>
<a class="sourceLine" id="cb92-16" data-line-number="16">std_err_testA &lt;-<span class="st"> </span><span class="kw">compute_simultaneous_ci</span>(eic_matrix_testA)</a>
<a class="sourceLine" id="cb92-17" data-line-number="17">upper_bound_testA &lt;-<span class="st"> </span>survival_curve_testA <span class="op">+</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_testA)</a>
<a class="sourceLine" id="cb92-18" data-line-number="18">lower_bound_testA &lt;-<span class="st"> </span>survival_curve_testA <span class="op">-</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_testA)</a>
<a class="sourceLine" id="cb92-19" data-line-number="19"></a>
<a class="sourceLine" id="cb92-20" data-line-number="20">plotdf_testA &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> k_grid, <span class="dt">est =</span> survival_curve_testA, </a>
<a class="sourceLine" id="cb92-21" data-line-number="21">                           <span class="dt">upper =</span> upper_bound_testA, <span class="dt">lower =</span> lower_bound_testA, </a>
<a class="sourceLine" id="cb92-22" data-line-number="22">                           <span class="dt">type =</span> <span class="kw">rep</span>(<span class="st">&quot;test&quot;</span>, <span class="kw">length</span>(k_grid)))</a>
<a class="sourceLine" id="cb92-23" data-line-number="23"></a>
<a class="sourceLine" id="cb92-24" data-line-number="24">plot_testA &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> plotdf_testA, <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> est)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb92-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> plotdf_testA, <span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb92-27" data-line-number="27"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Treatment-Specific Survival Curves Among Test Treatment Group in</span></a>
<a class="sourceLine" id="cb92-28" data-line-number="28"><span class="st">           Veterans’ Administration Lung Cancer Trial&quot;</span>)</a>
<a class="sourceLine" id="cb92-29" data-line-number="29">plot_testA</a></code></pre></div>
<p><img src="deming2019_workshop_files/figure-html/moss-4-test-1.png" width="70%" style="display: block; margin: auto;" /></p>

<p>counseling# Optimal Individualized Treatment Regimes</p>
<p>Based on the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> <code>R</code> package</a>
by <em>Ivana Malenica, Jeremy Coyle, and Mark van der Laan</em>.</p>
<p>Updated: 2019-12-06</p>
</div>
</div>
<div id="learning-objectives-3" class="section level2">
<h2><span class="header-section-number">6.4</span> Learning Objectives</h2>
<p>By the end of this lesson you will be able to:</p>
<ol style="list-style-type: decimal">
<li>Differentiate dynamic and optimal dynamic treatment interventions from static
interventions.</li>
<li>Explain the benefits and challenges associated with using optimal
individualized treatment regimes in practice.</li>
<li>Contrast the impact of implementing an optimal individualized treatment
regime in the population with the impact of implementing static and dynamic
treatment regimes in the population.</li>
<li>Estimate causal effects under optimal individualized treatment regimes with
the <code>tmle3mopttx</code> <code>R</code> package.</li>
<li>Implement optimal individualized treatment rules based on sub-optimal
rules, or “simple” rules, and recognize the practical benefit of these rules.</li>
<li>Construct “realistic” optimal individualized treatment regimes that respect
real data and subject-matter knowledge limitations on interventions by
only considering interventions that are supported by the data.</li>
<li>Measure variable importance as defined in terms of optimal individualized
treatment interventions.</li>
</ol>
</div>
<div id="introduction-to-optimal-individualized-interventions" class="section level2">
<h2><span class="header-section-number">6.5</span> Introduction to Optimal Individualized Interventions</h2>
<p>Identifying which intervention will be effective for which patient based on
lifestyle, genetic and environmental factors is a common goal in precision
medicine. One opts to administer the intervention to individuals who will
profit from it, instead of assigning treatment on a population level.</p>
<ul>
<li>This aim motivates a different type of intervention, as opposed to the static
exposures we might be used to.</li>
<li>In this chapter, we learn about dynamic (individualized) interventions that
tailor the treatment decision based on the collected covariates.</li>
<li>In the statistics community, such a treatment strategy is termed
<strong>individualized treatment regimes</strong> (ITR), and the (counterfactual)
population mean outcome under an ITR is the <strong>value of the ITR</strong>.</li>
<li>Even more, suppose one wishes to maximize the population mean of an outcome,
where for each individual we have access to some set of measured covariates.
An ITR with the maximal value is referred to as an <strong>optimal ITR</strong> or the
<strong>optimal individualized treatment</strong>. Consequently, the value of an optimal
ITR is termed the <strong>optimal value</strong>, or the
<strong>mean under the optimal individualized treatment</strong>.</li>
<li>One opts to administer the intervention to individuals who will profit from
it, instead of assigning treatment on a population level. But how do we know
which intervention works for which patient?</li>
<li>For example, one might seek to improve retention in HIV care. In a randomized
clinical trial, several interventions show efficacy- including appointment
reminders through text messages, small cash incentives for on time clinic
visits, and peer health workers.</li>
<li>Ideally, we want to improve effectiveness by assigning each patient the
intervention they are most likely to benefit from, as well as improve
efficiency by not allocating resources to individuals that do not need them,
or would.</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-2"></span>
<img src="img/image/DynamicA_Illustration.png" alt="Illustration of a Dynamic Treatment Regime in a Clinical Setting" width="70%" />
<p class="caption">
Figure 6.1: Illustration of a Dynamic Treatment Regime in a Clinical Setting
</p>
</div>
<p>This aim motivates a different type of intervention, as opposed to the static
exposures we might be used to.</p>
<ul>
<li>In this chapter, we examine multiple examples of optimal individualized
treatment regimes and estimate the mean outcome under the ITR where the
candidate rules are restricted to depend only on user-supplied subset of the
baseline covariates.</li>
<li>In order to accomplish this, we present the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> <code>R</code>
package</a>, which features an
implementation of a recently developed algorithm for computing targeted
minimum loss-based estimates of a causal effect based on optimal ITR for
categorical treatment.</li>
<li>In particular, we will use <code>tmle3mopttx</code> to estimate optimal ITR and the
corresponding population value, construct realistic optimal ITRs, and perform
variable importance in terms of the mean under the optimal individualized
treatment.</li>
</ul>
<div id="data-structure-and-notation" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Data Structure and Notation</h3>
<ul>
<li>Suppose we observe <span class="math inline">\(n\)</span> independent and identically distributed observations
of the form <span class="math inline">\(O=(W,A,Y) \sim P_0\)</span>. <span class="math inline">\(P_0 \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span>
is the fully nonparametric model.</li>
<li>Denote <span class="math inline">\(A \in \mathcal{A}\)</span> as categorical treatment, where
<span class="math inline">\(\mathcal{A} \equiv \{a_1, \cdots, a_{n_A} \}\)</span> and <span class="math inline">\(n_A = |\mathcal{A}|\)</span>,
with <span class="math inline">\(n_A\)</span> denoting the number of categories.</li>
<li>Denote <span class="math inline">\(Y\)</span> as the final outcome, and <span class="math inline">\(W\)</span> a vector-valued collection of
baseline covariates.</li>
<li>The likelihood of the data admits a factorization, implied by the time
ordering of <span class="math inline">\(O\)</span>.
<span class="math display">\[\begin{equation*}\label{eqn:likelihood_factorization}
p_0(O) = p_{Y,0}(Y|A,W) p_{A,0}(A|W) p_{W,0}(W) = q_{Y,0}(Y|A,W) q_{A,0}(A|W) q_{W,0}(W),
\end{equation*}\]</span></li>
<li>Consequently, we define
<span class="math inline">\(P_{Y,0}(Y|A,W)=Q_{Y,0}(Y|A,W)\)</span>, <span class="math inline">\(P_{A,0}(A|W)=g_0(A|W)\)</span> and <span class="math inline">\(P_{W,0}(W)=Q_{W,0}(W)\)</span>
as the corresponding conditional distributions of <span class="math inline">\(Y\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(W\)</span>.</li>
<li>We also define <span class="math inline">\(\bar{Q}_{Y,0}(A,W) \equiv E_0[Y|A,W]\)</span>.</li>
<li>Finally, denote <span class="math inline">\(V\)</span> as <span class="math inline">\(V \in W\)</span>, defining a subset of the baseline covariates
the optimal individualized rule depends on.</li>
</ul>
</div>
<div id="defining-the-causal-effect-of-an-optimal-individualized-intervention" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Defining the Causal Effect of an Optimal Individualized Intervention</h3>
<ul>
<li>Consider dynamic treatment rules
<span class="math inline">\(V \rightarrow d(V) \in \{a_1, \cdots, a_{n_A} \} \times \{1\}\)</span>,
for assigning treatment <span class="math inline">\(A\)</span> based on <span class="math inline">\(V \in W\)</span>.</li>
<li>Dynamic treatment regime may be viewed as an intervention in which <span class="math inline">\(A\)</span> is set
equal to a value based on a hypothetical regime <span class="math inline">\(d(V)\)</span>, and <span class="math inline">\(Y_{d(V)}\)</span> is the
corresponding counterfactual outcome under <span class="math inline">\(d(V)\)</span>.</li>
<li><p>The goal of any causal analysis motivated by an optimal individualized
intervention is to estimate a parameter defined as the counterfactual mean of
the outcome with respect to the modified intervention distribution.</p></li>
<li>Recall causal assumptions:</li>
</ul>
<ol style="list-style-type: decimal">
<li><strong>Consistency</strong>: <span class="math inline">\(Y^{d(v_i)}_i = Y_i\)</span> in the event <span class="math inline">\(A_i = d(v_i)\)</span>,
for <span class="math inline">\(i = 1, \ldots, n\)</span>.</li>
<li><strong>Stable unit value treatment assumption (SUTVA)</strong>: <span class="math inline">\(Y^{d(v_i)}_i\)</span> does
not depend on <span class="math inline">\(d(v_j)\)</span> for <span class="math inline">\(i = 1, \ldots, n\)</span> and <span class="math inline">\(j \neq i\)</span>, or lack
of interference.</li>
<li><strong>Strong ignorability</strong>: <span class="math inline">\(A \perp \!\!\! \perp Y^{d(v)} \mid W\)</span>, for all
<span class="math inline">\(a \in \mathcal{A}\)</span>.</li>
<li><strong>Positivity (or overlap)</strong>: <span class="math inline">\(P_0(\min_{a \in \mathcal{A}} g_0(a|W) &gt; 0)=1\)</span>.</li>
</ol>
<ul>
<li>Here, we also assume non-exceptional law is in effect.</li>
<li>We are primarily interested in the value of an individualized rule,
<span class="math display">\[E_0[Y_{d(V)}] = E_{0,W}[\bar{Q}_{Y,0}(A=d(V),W)].\]</span></li>
<li>The optimal rule is the rule with the maximal value:
<span class="math display">\[d_{opt}(V) \equiv \text{argmax}_{d(V) \in \mathcal{D}} E_0[Y_{d(V)}]\]</span>
where <span class="math inline">\(\mathcal{D}\)</span> represents the set of possible rules, <span class="math inline">\(d\)</span>, implied by <span class="math inline">\(V\)</span>.</li>
<li>The target causal estimand of our analysis is:
<span class="math display">\[\psi_0 := E_0[Y_{d_{opt}(V)}] =  E_{0,W}[\bar{Q}_{Y,0}(A=d_{opt}(V),W)].\]</span></li>
<li>General, high-level idea:
<ol style="list-style-type: decimal">
<li>Learn the optimal ITR using the Super Learner.</li>
<li>Estimate its value with the cross-validated Targeted Minimum Loss-based
Estimator (CV-TMLE).</li>
</ol></li>
</ul>
</div>
<div id="why-cv-tmle" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Why CV-TMLE?</h3>
<ul>
<li>CV-TMLE is necessary as the non-cross-validated TMLE is biased upward for the
mean outcome under the rule, and therefore overly optimistic.</li>
<li>More generally however, using CV-TMLE allows us more freedom in estimation
and therefore greater data adaptivity, without sacrificing inference!</li>
</ul>
</div>
</div>
<div id="optimal-itr-with-a-binary-treatment" class="section level2">
<h2><span class="header-section-number">6.6</span> Optimal ITR with a Binary Treatment</h2>
<ul>
<li>How do we estimate the optimal individualized treatment regime? In the case
of a binary treatment, a key quantity for optimal ITR is the <strong>blip</strong>
function.</li>
<li>Optimal ITR ideally assigns treatment to individuals falling in strata in
which the stratum specific average treatment effect, the <strong>blip</strong> function,
is positive and does not assign treatment to individuals for which this
quantity is negative.</li>
<li>We define the blip function as:
<span class="math display">\[\bar{Q}_0(V)\equiv E_0[Y_1-Y_0|V]\equiv E_0[\bar{Q}_{Y,0}(1,W) - \bar{Q}_{Y,0}(0,W)|V],\]</span> or the average treatment effect within a stratum of <span class="math inline">\(V\)</span>.</li>
<li>Optimal individualized rule can now be derived as
<span class="math inline">\(d_{opt}(V) = I(\bar{Q}_{0}(V) &gt; 0)\)</span>.</li>
<li>Relying on the Targeted Maximum Likelihood (TML) estimator and the Super
Learner estimate of the blip function, we follow the below steps in order to
obtain value of the ITR:
<ol style="list-style-type: decimal">
<li>Estimate <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> and <span class="math inline">\(g_0(A|W)\)</span> using <code>sl3</code>. We denote such
estimates as <span class="math inline">\(\bar{Q}_{Y,n}(A,W)\)</span> and <span class="math inline">\(g_n(A|W)\)</span>.</li>
<li>Apply the doubly robust Augmented-Inverse Probability Weighted (A-IPW)
transform to our outcome, where we define:</li>
</ol></li>
</ul>
<p><span class="math display">\[D_{\bar{Q}_Y,g,a}(O) \equiv \frac{I(A=a)}{g(A|W)} (Y-\bar{Q}_Y(A,W)) + \bar{Q}_Y(A=a,W)\]</span></p>
<p>Note that under the randomization and positivity assumptions we have that
<span class="math inline">\(E[D_{\bar{Q}_Y,g,a}(O) | V] = E[Y_a |V].\)</span> We emphasize the double robust nature
of the A-IPW transform: consistency of <span class="math inline">\(E[Y_a |V]\)</span> will depend on correct
estimation of either <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> or <span class="math inline">\(g_0(A|W)\)</span>. As such, in a
randomized trial, we are guaranteed a consistent estimate of <span class="math inline">\(E[Y_a |V]\)</span> even
if we get <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> wrong!</p>
<p>Using this transform, we can define the following contrast:</p>
<p><span class="math display">\[D_{\bar{Q}_Y,g}(O) = D_{\bar{Q}_Y,g,a=1}(O) - D_{\bar{Q}_Y,g,a=0}(O)\]</span></p>
<p>We estimate the blip function, <span class="math inline">\(\bar{Q}_{0,a}(V)\)</span>, by regressing
<span class="math inline">\(D_{\bar{Q}_Y,g}(O)\)</span> on <span class="math inline">\(V\)</span> using the specified <code>sl3</code> library of learners and
an appropriate loss function.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Our estimated rule is <span class="math inline">\(d(V) = \text{argmax}_{a \in \mathcal{A}} \bar{Q}_{0,a}(V)\)</span>.</p></li>
<li><p>We obtain inference for the mean outcome under the estimated optimal rule
using CV-TMLE.</p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-a-binary-treatment" class="section level3">
<h3><span class="header-section-number">6.6.1</span> Evaluating the Causal Effect of an Optimal ITR with a Binary Treatment</h3>
<p>To start, let us load the packages we will use and set a seed for simulation:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="kw">library</span>(here)</a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="kw">library</span>(sl3)</a>
<a class="sourceLine" id="cb93-4" data-line-number="4"><span class="kw">library</span>(tmle3)</a>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="kw">library</span>(tmle3mopttx)</a>
<a class="sourceLine" id="cb93-6" data-line-number="6"><span class="kw">library</span>(devtools)</a>
<a class="sourceLine" id="cb93-7" data-line-number="7"><span class="kw">set.seed</span>(<span class="dv">111</span>)</a></code></pre></div>
<div id="data-simulation" class="section level4">
<h4><span class="header-section-number">6.6.1.1</span> Data Simulation</h4>
<p>Our data generating distribution is of the following form:</p>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{3 \times 3})\]</span>
<span class="math display">\[P(A=1|W) = \frac{1}{1+\exp^{(-0.8*W_1)}}\]</span>
<span class="math display">\[P(Y=1|A,W) = 0.5\text{logit}^{-1}[-5I(A=1)(W_1-0.5)+5I(A=0)(W_1-0.5)] +
0.5\text{logit}^{-1}(W_2W_3)\]</span></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;data_bin&quot;</span>)</a></code></pre></div>
<ul>
<li><p>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
<li><p>Note that the mean under the true optimal rule is <span class="math inline">\(\psi=0.578\)</span> for this
data-generating distribution.</p></li>
<li><p>Next, we specify the role that each variable in the data set plays as the
nodes in a DAG.</p></li>
</ul>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="co"># organize data and nodes for tmle3</span></a>
<a class="sourceLine" id="cb95-2" data-line-number="2">data &lt;-<span class="st"> </span>data_bin</a>
<a class="sourceLine" id="cb95-3" data-line-number="3">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb95-4" data-line-number="4">  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>),</a>
<a class="sourceLine" id="cb95-5" data-line-number="5">  <span class="dt">A =</span> <span class="st">&quot;A&quot;</span>,</a>
<a class="sourceLine" id="cb95-6" data-line-number="6">  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span></a>
<a class="sourceLine" id="cb95-7" data-line-number="7">)</a></code></pre></div>
<ul>
<li>We now have an observed data structure (<code>data</code>), and a specification of the
role that each variable in the data set plays as the nodes in a DAG.</li>
</ul>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3" class="section level4">
<h4><span class="header-section-number">6.6.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code></h4>
<ul>
<li>We generate three different ensemble learners that must be fit, corresponding
to the learners for the outcome regression, propensity score, and the blip
function.</li>
</ul>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="co"># Define sl3 library and metalearners:</span></a>
<a class="sourceLine" id="cb96-2" data-line-number="2">lrn_xgboost_<span class="dv">50</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb96-3" data-line-number="3">lrn_xgboost_<span class="dv">100</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb96-4" data-line-number="4">lrn_xgboost_<span class="dv">500</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">500</span>)</a>
<a class="sourceLine" id="cb96-5" data-line-number="5">lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb96-6" data-line-number="6">lrn_glm &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb96-7" data-line-number="7"></a>
<a class="sourceLine" id="cb96-8" data-line-number="8">## Define the Q learner:</a>
<a class="sourceLine" id="cb96-9" data-line-number="9">Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb96-10" data-line-number="10">  <span class="dt">learners =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb96-11" data-line-number="11">    lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>,</a>
<a class="sourceLine" id="cb96-12" data-line-number="12">    lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm</a>
<a class="sourceLine" id="cb96-13" data-line-number="13">  ),</a>
<a class="sourceLine" id="cb96-14" data-line-number="14">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb96-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb96-16" data-line-number="16"></a>
<a class="sourceLine" id="cb96-17" data-line-number="17">## Define the g learner:</a>
<a class="sourceLine" id="cb96-18" data-line-number="18">g_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb96-19" data-line-number="19">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">100</span>, lrn_glm),</a>
<a class="sourceLine" id="cb96-20" data-line-number="20">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb96-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb96-22" data-line-number="22"></a>
<a class="sourceLine" id="cb96-23" data-line-number="23">## Define the B learner:</a>
<a class="sourceLine" id="cb96-24" data-line-number="24">b_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb96-25" data-line-number="25">  <span class="dt">learners =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb96-26" data-line-number="26">    lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>,</a>
<a class="sourceLine" id="cb96-27" data-line-number="27">    lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm</a>
<a class="sourceLine" id="cb96-28" data-line-number="28">  ),</a>
<a class="sourceLine" id="cb96-29" data-line-number="29">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb96-30" data-line-number="30">)</a></code></pre></div>
<p>We make the above explicit with respect to standard notation by bundling the
ensemble learners into a list object below:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="co"># specify outcome and treatment regressions and create learner list</span></a>
<a class="sourceLine" id="cb97-2" data-line-number="2">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</a></code></pre></div>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-itr-effect" class="section level4">
<h4><span class="header-section-number">6.6.1.3</span> Targeted Estimation of the Mean under the Optimal ITR Effect</h4>
<ul>
<li>To start, we will initialize a specification for the TMLE of our parameter of
interest simply by calling <code>tmle3_mopttx_blip_revere</code>.</li>
<li>We specify the argument <code>V = c(&quot;W1&quot;, &quot;W2&quot;, &quot;W3&quot;)</code> when initializing the
<code>tmle3_Spec</code> object in order to communicate that we’re interested in learning
a rule dependent on <code>V</code> covariates.</li>
<li>We also need to specify the type of blip we will use in this estimation
problem, and the list of learners used to estimate relevant parts of the
likelihood and the blip function.</li>
<li>In addition, we need to specify whether we want to maximize or minimize the
mean outcome under the rule (<code>maximize=TRUE</code>).</li>
<li>If <code>complex=FALSE</code>, <code>tmle3mopttx</code> will consider all the possible rules under
a smaller set of covariates including the static rules, and optimize the mean
outcome over all the suboptimal rules dependent on <span class="math inline">\(V\)</span>.</li>
<li>If <code>realistic=TRUE</code>, only treatments supported by the data will be considered,
therefore alleviating concerns regarding practical positivity issues.</li>
</ul>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb98-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb98-3" data-line-number="3">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip1&quot;</span>,</a>
<a class="sourceLine" id="cb98-4" data-line-number="4">  <span class="dt">learners =</span> learner_list,</a>
<a class="sourceLine" id="cb98-5" data-line-number="5">  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb98-6" data-line-number="6">  <span class="dt">realistic =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb98-7" data-line-number="7">)</a></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb99-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a>
<a class="sourceLine" id="cb99-3" data-line-number="3">fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.4289592 0.5701264 0.02749039 0.5162462 0.6240065
   psi_transformed lower_transformed upper_transformed
1:       0.5701264         0.5162462         0.6240065</code></pre>
<p>We can see that the confidence interval covers our true mean under the true
optimal individualized treatment!</p>
</div>
</div>
</div>
<div id="optimal-itr-with-a-categorical-treatment" class="section level2">
<h2><span class="header-section-number">6.7</span> Optimal ITR with a Categorical Treatment</h2>
<p><strong>QUESTION:</strong> Can we still use the blip function if the treatment is
categorical?</p>
<ul>
<li>In this section, we consider how to evaluate the mean outcome under the
optimal individualized treatment when <span class="math inline">\(A\)</span> has more than two categories!</li>
<li>We define <strong>pseudo-blips</strong> as vector valued entities where the output for a
given <span class="math inline">\(V\)</span> is a vector of length equal to the number of treatment categories,
<span class="math inline">\(n_A\)</span>. As such, we define it as:
<span class="math display">\[\bar{Q}_0^{pblip}(V) = \{\bar{Q}_{0,a}^{pblip}(V): a \in \mathcal{A} \}\]</span></li>
<li>We implement three different pseudo-blips in <code>tmle3mopttx</code>.</li>
</ul>
<ol style="list-style-type: decimal">
<li><strong>Blip1</strong> corresponds to choosing a reference category of treatment, and
defining the blip for all other categories relative to the specified
reference: <span class="math display">\[\bar{Q}_{0,a}^{pblip-ref}(V) \equiv E_0(Y_a-Y_0|V)\]</span></li>
<li><p><strong>Blip2</strong> approach corresponds to defining the blip relative to the average
of all categories:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-avg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_a|V)\]</span></p></li>
<li><p><strong>Blip3</strong> reflects an extension of Blip2, where the average is now a weighted
average:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-wavg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_{a} P(A=a|V)
|V)\]</span></p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-a-categorical-treatment" class="section level3">
<h3><span class="header-section-number">6.7.1</span> Evaluating the Causal Effect of an Optimal ITR with a Categorical Treatment</h3>
<p>While the procedure is analogous to the previously described binary treatment,
we now need to pay attention to the type of blip we define in the estimation
stage, as well as how we construct our learners.</p>
<div id="data-simulation-1" class="section level4">
<h4><span class="header-section-number">6.7.1.1</span> Data Simulation</h4>
<ul>
<li>First, we load the simulated data. Here, our data generating distribution was
of the following form:</li>
</ul>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{4 \times 4})\]</span>
<span class="math display">\[P(A|W) = \frac{1}{1+\exp^{(-(0.05*I(A=1) * W_1+0.8*I(A=2) * W_1+0.8*I(A=3) * W_1))}}\]</span></p>
<p><span class="math display">\[P(Y|A,W) = 0.5\text{logit}^{-1}[15I(A=1)(W_1-0.5) - 3I(A=2)(2W_1+0.5) \\
+ 3I(A=3)(3W_1-0.5)] +\text{logit}^{-1}(W_2W_1)\]</span></p>
<ul>
<li>We can just load the data available as part of the package as follows:</li>
</ul>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;data_cat_realistic&quot;</span>)</a></code></pre></div>
<ul>
<li>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>. Note that the
mean under the true optimal rule is <span class="math inline">\(\psi=0.658\)</span>, which is the quantity we aim
to estimate.</li>
</ul>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1"><span class="co"># organize data and nodes for tmle3</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2">data &lt;-<span class="st"> </span>data_cat_realistic</a>
<a class="sourceLine" id="cb102-3" data-line-number="3">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb102-4" data-line-number="4">  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>),</a>
<a class="sourceLine" id="cb102-5" data-line-number="5">  <span class="dt">A =</span> <span class="st">&quot;A&quot;</span>,</a>
<a class="sourceLine" id="cb102-6" data-line-number="6">  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span></a>
<a class="sourceLine" id="cb102-7" data-line-number="7">)</a></code></pre></div>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3-1" class="section level4">
<h4><span class="header-section-number">6.7.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code></h4>
<p><strong>QUESTION:</strong> With categorical treatment, what is the dimension of the blip now?
How would we go about estimating it?</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1"><span class="co"># Initialize few of the learners:</span></a>
<a class="sourceLine" id="cb103-2" data-line-number="2">lrn_xgboost_<span class="dv">50</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb103-3" data-line-number="3">lrn_xgboost_<span class="dv">100</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb103-4" data-line-number="4">lrn_xgboost_<span class="dv">500</span> &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">500</span>)</a>
<a class="sourceLine" id="cb103-5" data-line-number="5">lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb103-6" data-line-number="6">lrn_glm &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb103-7" data-line-number="7"></a>
<a class="sourceLine" id="cb103-8" data-line-number="8">## Define the Q learner, which is just a regular learner:</a>
<a class="sourceLine" id="cb103-9" data-line-number="9">Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb103-10" data-line-number="10">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>, lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm),</a>
<a class="sourceLine" id="cb103-11" data-line-number="11">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb103-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb103-13" data-line-number="13"></a>
<a class="sourceLine" id="cb103-14" data-line-number="14"><span class="co"># Define the g learner, which is a multinomial learner:</span></a>
<a class="sourceLine" id="cb103-15" data-line-number="15"><span class="co"># specify the appropriate loss of the multinomial learner:</span></a>
<a class="sourceLine" id="cb103-16" data-line-number="16">mn_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp,</a>
<a class="sourceLine" id="cb103-17" data-line-number="17">  <span class="dt">loss_function =</span> loss_loglik_multinomial,</a>
<a class="sourceLine" id="cb103-18" data-line-number="18">  <span class="dt">learner_function =</span> metalearner_linear_multinomial</a>
<a class="sourceLine" id="cb103-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb103-20" data-line-number="20">g_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_sl, <span class="kw">list</span>(lrn_xgboost_<span class="dv">100</span>, lrn_xgboost_<span class="dv">500</span>, lrn_mean), mn_metalearner)</a>
<a class="sourceLine" id="cb103-21" data-line-number="21"></a>
<a class="sourceLine" id="cb103-22" data-line-number="22"><span class="co"># Define the Blip learner, which is a multivariate learner:</span></a>
<a class="sourceLine" id="cb103-23" data-line-number="23">learners &lt;-<span class="st"> </span><span class="kw">list</span>(lrn_xgboost_<span class="dv">50</span>, lrn_xgboost_<span class="dv">100</span>, lrn_xgboost_<span class="dv">500</span>, lrn_mean, lrn_glm)</a>
<a class="sourceLine" id="cb103-24" data-line-number="24">b_learner &lt;-<span class="st"> </span><span class="kw">create_mv_learners</span>(<span class="dt">learners =</span> learners)</a></code></pre></div>
<ul>
<li>We generate three different ensemble learners that must be fit, corresponding
to the learners for the outcome regression, propensity score, and the blip
function.</li>
<li>Note that we need to estimate <span class="math inline">\(g_0(A|W)\)</span> for a categorical <span class="math inline">\(A\)</span>- therefore we
use the multinomial Super Learner option available within the <code>sl3</code> package
with learners that can address multi-class classification problems.</li>
<li>In order to see which learners can be used to estimate <span class="math inline">\(g_0(A|W)\)</span> in <code>sl3</code>,
we run the following:</li>
</ul>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="co"># See which learners support multi-class classification:</span></a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="kw">sl3_list_learners</span>(<span class="kw">c</span>(<span class="st">&quot;categorical&quot;</span>))</a></code></pre></div>
<pre><code> [1] &quot;Lrnr_bartMachine&quot;           &quot;Lrnr_caret&quot;                
 [3] &quot;Lrnr_dbarts&quot;                &quot;Lrnr_gam&quot;                  
 [5] &quot;Lrnr_glmnet&quot;                &quot;Lrnr_grf&quot;                  
 [7] &quot;Lrnr_h2o_glm&quot;               &quot;Lrnr_h2o_grid&quot;             
 [9] &quot;Lrnr_independent_binomial&quot;  &quot;Lrnr_mean&quot;                 
[11] &quot;Lrnr_multivariate&quot;          &quot;Lrnr_optim&quot;                
[13] &quot;Lrnr_polspline&quot;             &quot;Lrnr_pooled_hazards&quot;       
[15] &quot;Lrnr_randomForest&quot;          &quot;Lrnr_ranger&quot;               
[17] &quot;Lrnr_rpart&quot;                 &quot;Lrnr_screener_corP&quot;        
[19] &quot;Lrnr_screener_corRank&quot;      &quot;Lrnr_screener_randomForest&quot;
[21] &quot;Lrnr_solnp&quot;                 &quot;Lrnr_svm&quot;                  
[23] &quot;Lrnr_xgboost&quot;              </code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1"><span class="co"># specify outcome and treatment regressions and create learner list</span></a>
<a class="sourceLine" id="cb106-2" data-line-number="2">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</a></code></pre></div>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-itr-effects" class="section level4">
<h4><span class="header-section-number">6.7.1.3</span> Targeted Estimation of the Mean under the Optimal ITR Effects</h4>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb107-3" data-line-number="3">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb107-4" data-line-number="4">  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb107-5" data-line-number="5">  <span class="dt">realistic =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb107-6" data-line-number="6">)</a></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb108-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a>
<a class="sourceLine" id="cb108-3" data-line-number="3">fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.5388064 0.6087992 0.07433631 0.4631027 0.7544957
   psi_transformed lower_transformed upper_transformed
1:       0.6087992         0.4631027         0.7544957</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" data-line-number="1"><span class="co"># How many individuals got assigned each treatment?</span></a>
<a class="sourceLine" id="cb110-2" data-line-number="2"><span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</a></code></pre></div>
<pre><code>
  1   2   3 
440 388 172 </code></pre>
<p>We can see that the confidence interval covers our true mean under the true
optimal individualized treatment.</p>
<p><strong>NOTICE the distribution of the assigned treatment! We will need this shortly.</strong></p>
</div>
</div>
</div>
<div id="extensions-to-causal-effect-of-an-oit" class="section level2">
<h2><span class="header-section-number">6.8</span> Extensions to Causal Effect of an OIT</h2>
<ul>
<li>We consider two extensions to the procedure described for estimating the
value of the ITR.</li>
<li>The first one considers a setting where the user might be interested in a
grid of possible suboptimal rules, corresponding to potentially limited
knowledge of potential effect modifiers (<strong>Simpler Rules</strong>).</li>
<li>The second extension concerns implementation of realistic optimal individual
interventions where certain regimes might be preferred, but due to practical
or global positivity restraints are not realistic to implement
(<strong>Realistic Interventions</strong>).</li>
</ul>
<div id="simpler-rules" class="section level3">
<h3><span class="header-section-number">6.8.1</span> Simpler Rules</h3>
<ul>
<li>In order to not only consider the most ambitious fully <span class="math inline">\(V\)</span>-optimal rule, we
define <span class="math inline">\(S\)</span>-optimal rules as the optimal rule that considers all possible
subsets of <span class="math inline">\(V\)</span> covariates, with card(<span class="math inline">\(S\)</span>) <span class="math inline">\(\leq\)</span> card(<span class="math inline">\(V\)</span>) and
<span class="math inline">\(\emptyset \in S\)</span>.</li>
<li>This allows us to consider sub-optimal rules that are easier to estimate and
potentially provide more realistic rules- as such, we allow for statistical
inference for the counterfactual mean outcome under the sub-optimal rule.</li>
</ul>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb112-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb112-3" data-line-number="3">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W1&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb112-4" data-line-number="4">  <span class="dt">learners =</span> learner_list,</a>
<a class="sourceLine" id="cb112-5" data-line-number="5">  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">FALSE</span>, <span class="dt">realistic =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb112-6" data-line-number="6">)</a></code></pre></div>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb113-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a>
<a class="sourceLine" id="cb113-3" data-line-number="3">fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type             param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=W3,W2,W1}] 0.5443612 0.5718773 0.06647258 0.4415935 0.7021612
   psi_transformed lower_transformed upper_transformed
1:       0.5718773         0.4415935         0.7021612</code></pre>
<p>Even though the user specified all baseline covariates as the basis for rule
estimation, a simpler rule is sufficient to maximize the mean under the optimal
individualized treatment!</p>
<p><strong>QUESTION:</strong> Why do you think the estimate is higher under the less complex
rule? How does the set of covariates picked by <code>tmle3mopttx</code> compare to the
baseline covariates the true rule depends on?</p>
</div>
<div id="realistic-optimal-individual-regimes" class="section level3">
<h3><span class="header-section-number">6.8.2</span> Realistic Optimal Individual Regimes</h3>
<ul>
<li><code>tmle3mopttx</code> also provides an option to estimate the mean under the
realistic, or implementable, optimal individualized treatment.</li>
<li>It is often the case that assigning particular regime might have the ability
to fully maximize (or minimize) the desired outcome, but due to global or
practical positivity constrains, such treatment can never be implemented in
real life (or is highly unlikely).</li>
<li>Specifying <code>realistic=&quot;TRUE&quot;</code>, we consider possibly suboptimal treatments
that optimize the outcome in question while being supported by the data.</li>
</ul>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb115-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb115-3" data-line-number="3">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;W1&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb115-4" data-line-number="4">  <span class="dt">learners =</span> learner_list,</a>
<a class="sourceLine" id="cb115-5" data-line-number="5">  <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>, <span class="dt">realistic =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb115-6" data-line-number="6">)</a></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb116-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a>
<a class="sourceLine" id="cb116-3" data-line-number="3">fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.552654 0.6503015 0.02177991 0.6076136 0.6929893
   psi_transformed lower_transformed upper_transformed
1:       0.6503015         0.6076136         0.6929893</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="co"># How many individuals got assigned each treatment?</span></a>
<a class="sourceLine" id="cb118-2" data-line-number="2"><span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</a></code></pre></div>
<pre><code>
  2   3 
507 493 </code></pre>
<p><strong>QUESTION:</strong> Referring back to the data-generating distribution, why do you
think the distribution of allocated treatment changed from the distribution
that we had under the “non-realistic” rule?</p>
</div>
<div id="variable-importance-analysis" class="section level3">
<h3><span class="header-section-number">6.8.3</span> Variable Importance Analysis</h3>
<ul>
<li>In the previous sections we have seen how to obtain a contrast between the
mean under the optimal individualized rule and the mean under the observed
outcome for a single covariate. We are now ready to run the variable
importance analysis for all of our observed covariates!</li>
<li>In order to run <code>tmle3mopttx</code> variable importance measure, we need considered
covariates to be categorical variables.</li>
<li>For illustration purpose, we bin baseline covariates corresponding to the
data-generating distribution described in the previous section:</li>
</ul>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1"><span class="co"># bin baseline covariates to 3 categories:</span></a>
<a class="sourceLine" id="cb120-2" data-line-number="2">data<span class="op">$</span>W1 &lt;-<span class="st"> </span><span class="kw">ifelse</span>(data<span class="op">$</span>W1 <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">2</span>], <span class="dv">1</span>, <span class="kw">ifelse</span>(data<span class="op">$</span>W1 <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(data<span class="op">$</span>W1)[<span class="dv">3</span>], <span class="dv">2</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb120-3" data-line-number="3"></a>
<a class="sourceLine" id="cb120-4" data-line-number="4">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb120-5" data-line-number="5">  <span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W3&quot;</span>, <span class="st">&quot;W4&quot;</span>, <span class="st">&quot;W2&quot;</span>),</a>
<a class="sourceLine" id="cb120-6" data-line-number="6">  <span class="dt">A =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;A&quot;</span>),</a>
<a class="sourceLine" id="cb120-7" data-line-number="7">  <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span></a>
<a class="sourceLine" id="cb120-8" data-line-number="8">)</a></code></pre></div>
<ul>
<li>Note that our node list now includes <span class="math inline">\(W_1\)</span> as treatments as well! Don’t
worry, we will still properly adjust for all baseline covariates when
considering <span class="math inline">\(A\)</span> as treatment.</li>
</ul>
<div id="variable-importance-using-targeted-estimation-of-the-value-of-the-itr" class="section level4">
<h4><span class="header-section-number">6.8.3.1</span> Variable Importance using Targeted Estimation of the value of the ITR</h4>
<ul>
<li>We will initialize a specification for the TMLE of our parameter of interest
(called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle3_mopttx_vim</code>.</li>
</ul>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb121-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_vim</span>(</a>
<a class="sourceLine" id="cb121-3" data-line-number="3">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;W2&quot;</span>),</a>
<a class="sourceLine" id="cb121-4" data-line-number="4">  <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb121-5" data-line-number="5">  <span class="dt">learners =</span> learner_list,</a>
<a class="sourceLine" id="cb121-6" data-line-number="6">  <span class="dt">contrast =</span> <span class="st">&quot;multiplicative&quot;</span>,</a>
<a class="sourceLine" id="cb121-7" data-line-number="7">  <span class="dt">maximize =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb121-8" data-line-number="8">  <span class="dt">method =</span> <span class="st">&quot;SL&quot;</span>,</a>
<a class="sourceLine" id="cb121-9" data-line-number="9">  <span class="dt">complex =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb121-10" data-line-number="10">  <span class="dt">realistic =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb121-11" data-line-number="11">)</a></code></pre></div>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="co"># fit the TML estimator</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2">vim_results &lt;-<span class="st"> </span><span class="kw">tmle3_vim</span>(tmle_spec, data, node_list, learner_list,</a>
<a class="sourceLine" id="cb122-3" data-line-number="3">  <span class="dt">adjust_for_other_A =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb122-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb122-5" data-line-number="5"></a>
<a class="sourceLine" id="cb122-6" data-line-number="6"><span class="kw">print</span>(vim_results)</a></code></pre></div>
<pre><code>   type                  param     init_est    tmle_est         se       lower
1:   RR RR(E[Y_{A=NULL}]/E[Y])  0.003574293  0.09596303 0.03282267  0.03163178
2:   RR RR(E[Y_{A=NULL}]/E[Y]) -0.024474352 -0.10266330 0.05128432 -0.20317872
          upper psi_transformed lower_transformed upper_transformed  A
1:  0.160294275       1.1007184         1.0321374         1.1738563  A
2: -0.002147868       0.9024308         0.8161324         0.9978544 W1
             W    Z_stat        p_nz p_nz_corrected
1: W3,W4,W2,W1  2.923682 0.001729592    0.003459185
2:  W3,W4,W2,A -2.001846 0.022650673    0.022650673</code></pre>
<p>The final result of <code>tmle3_vim</code> with the <code>tmle3mopttx</code> spec is an ordered list
of mean outcomes under the optimal individualized treatment for all categorical
covariates in our dataset.</p>
</div>
</div>
</div>
<div id="exercise-2" class="section level2">
<h2><span class="header-section-number">6.9</span> Exercise</h2>
<div id="causal-effect-of-the-optimal-itr-in-the-wash-benefits-trial" class="section level3">
<h3><span class="header-section-number">6.9.1</span> Causal Effect of the Optimal ITR in the WASH Benefits Trial</h3>
<p>Finally, we cement everything we learned so far with a real data application.</p>
<p>We will be using the WASH Benefits data, corresponding to the effect of water
quality, sanitation, hand washing, and nutritional interventions on child
development in a rural Bangladesh trial.</p>
<p>The main aim of the cluster-randomized controlled trial was to assess the
impact of six intervention groups, including:</p>
<ol style="list-style-type: decimal">
<li>Control</li>
<li>Hand washing with soap</li>
<li>Improved nutrition through counseling and provision of lipid-based nutrient
supplements</li>
<li>Combined water, sanitation, hand washing, and nutrition.</li>
<li>Improved sanitation</li>
<li>Combined water, sanitation, and hand washing</li>
<li>Chlorinated drinking water</li>
</ol>
<p>Estimate the optimal ITR and the corresponding value under the optimal ITR for
the main intervention in WASH Benefits data. The outcome of interest is the
weight-for-height Z-score (<code>whz</code>), and the treatment is the six intervention
groups aimed at improving living conditions.</p>
<ol style="list-style-type: decimal">
<li>Define <span class="math inline">\(V\)</span> as mother’s education (<code>momedu</code>), current living conditions
(<code>floor</code>), and possession of material items including the refrigerator
(<code>asset_refrig</code>). Why do you think these covariates are used as <span class="math inline">\(V\)</span>? Should
the outcome be minimized or maximized? Which blip type should be utilized?
Construct an appropriate <code>sl3</code> library for <span class="math inline">\(A\)</span>, <span class="math inline">\(Y\)</span> and <span class="math inline">\(B\)</span>.</li>
<li>Based on the <span class="math inline">\(V\)</span> defined in the previous question, estimate the mean under
the ITR for the main randomized intervention (<code>tr</code>) used in the WASH Benefits
trial with weight-for-height Z-score as the outcome (<code>whz</code>). What is the
estimated value of the optimal ITR? How does it change from the initial
estimate? Which intervention is the most dominant and why?</li>
<li>Using the same formulation in questions 1 and 2, estimate the realistic
optimal ITR and the corresponding value of the realistic ITR. Did the results
change? Which intervention is the most dominant under realistic rules? Why
do you think that is?</li>
</ol>
</div>
</div>
<div id="summary-2" class="section level2">
<h2><span class="header-section-number">6.10</span> Summary</h2>
<ul>
<li>The mean outcome under the optimal individualized treatment is a
counterfactual quantity of interest representing what the mean outcome would
have been if everybody, contrary to the fact, received treatment that
optimized their outcome.</li>
<li><code>tmle3mopttx</code> estimates the mean outcome under the optimal individualized
treatment, where the candidate rules are restricted to only respond to a
user-supplied subset of the baseline and intermediate covariates.
Additionally, it provides options for realistic data-adaptive interventions.</li>
<li>In essence, our target parameter answers the key aim of precision medicine:
allocating the available treatment by tailoring it to the individual
characteristics of the patient, with the goal of optimizing the final outcome.</li>
</ul>
<div id="exercise-solutions-1" class="section level3">
<h3><span class="header-section-number">6.10.1</span> Exercise Solutions</h3>
<p>To start, let’s load the data, convert all columns to be of class <code>numeric</code>,
and take a quick look at it:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">washb_data &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data.csv&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb124-2" data-line-number="2">washb_data &lt;-<span class="st"> </span>washb_data[<span class="op">!</span><span class="kw">is.na</span>(momage), <span class="kw">lapply</span>(.SD, as.numeric)]</a>
<a class="sourceLine" id="cb124-3" data-line-number="3"><span class="kw">head</span>(washb_data, <span class="dv">3</span>)</a></code></pre></div>
<p>As before, we specify the NPSEM via the <code>node_list</code> object.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb125-2" data-line-number="2">  <span class="dt">W =</span> <span class="kw">names</span>(washb_data)[<span class="op">!</span>(<span class="kw">names</span>(washb_data) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;whz&quot;</span>, <span class="st">&quot;tr&quot;</span>))],</a>
<a class="sourceLine" id="cb125-3" data-line-number="3">  <span class="dt">A =</span> <span class="st">&quot;tr&quot;</span>, <span class="dt">Y =</span> <span class="st">&quot;whz&quot;</span></a>
<a class="sourceLine" id="cb125-4" data-line-number="4">)</a></code></pre></div>
<p>We pick few potential effect modifiers, including mother’s education, current
living conditions, and possession of material items including the refrigerator.
We concentrate of these covariates as they might be indicative of the
socio-economic status of individuals involved in the trial. We can explore the
distribution of our <span class="math inline">\(V\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1"><span class="co"># V1, V2 and V3:</span></a>
<a class="sourceLine" id="cb126-2" data-line-number="2"><span class="kw">table</span>(washb_data<span class="op">$</span>momedu)</a>
<a class="sourceLine" id="cb126-3" data-line-number="3"><span class="kw">table</span>(washb_data<span class="op">$</span>floor)</a>
<a class="sourceLine" id="cb126-4" data-line-number="4"><span class="kw">table</span>(washb_data<span class="op">$</span>asset_refrig)</a>
<a class="sourceLine" id="cb126-5" data-line-number="5"></a>
<a class="sourceLine" id="cb126-6" data-line-number="6"><span class="co"># A:</span></a>
<a class="sourceLine" id="cb126-7" data-line-number="7"><span class="kw">table</span>(washb_data<span class="op">$</span>tr)</a>
<a class="sourceLine" id="cb126-8" data-line-number="8"></a>
<a class="sourceLine" id="cb126-9" data-line-number="9"><span class="co"># Y:</span></a>
<a class="sourceLine" id="cb126-10" data-line-number="10"><span class="kw">summary</span>(washb_data<span class="op">$</span>whz)</a></code></pre></div>
<p>We specify a simply library for the outcome regression, propensity score and the
blip function. Since our treatment is categorical, we need to define a
multinomial learner for <span class="math inline">\(A\)</span> and multivariate learner for <span class="math inline">\(B\)</span>. We will define
the <code>xgboost</code> over a grid of parameters, and initialize a mean learner.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1"><span class="co"># Initialize few of the learners:</span></a>
<a class="sourceLine" id="cb127-2" data-line-number="2">grid_params &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb127-3" data-line-number="3">  <span class="dt">nrounds =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">500</span>),</a>
<a class="sourceLine" id="cb127-4" data-line-number="4">  <span class="dt">eta =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb127-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb127-6" data-line-number="6">grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(grid_params, <span class="dt">KEEP.OUT.ATTRS =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb127-7" data-line-number="7">xgb_learners &lt;-<span class="st"> </span><span class="kw">apply</span>(grid, <span class="dt">MARGIN =</span> <span class="dv">1</span>, <span class="cf">function</span>(params_tune) {</a>
<a class="sourceLine" id="cb127-8" data-line-number="8">  <span class="kw">do.call</span>(Lrnr_xgboost<span class="op">$</span>new, <span class="kw">c</span>(<span class="kw">as.list</span>(params_tune)))</a>
<a class="sourceLine" id="cb127-9" data-line-number="9">})</a>
<a class="sourceLine" id="cb127-10" data-line-number="10">lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb127-11" data-line-number="11"></a>
<a class="sourceLine" id="cb127-12" data-line-number="12">## Define the Q learner, which is just a regular learner:</a>
<a class="sourceLine" id="cb127-13" data-line-number="13">Q_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb127-14" data-line-number="14">  <span class="dt">learners =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb127-15" data-line-number="15">    xgb_learners[[<span class="dv">1</span>]], xgb_learners[[<span class="dv">2</span>]], xgb_learners[[<span class="dv">3</span>]],</a>
<a class="sourceLine" id="cb127-16" data-line-number="16">    xgb_learners[[<span class="dv">4</span>]], lrn_mean</a>
<a class="sourceLine" id="cb127-17" data-line-number="17">  ),</a>
<a class="sourceLine" id="cb127-18" data-line-number="18">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb127-19" data-line-number="19">)</a>
<a class="sourceLine" id="cb127-20" data-line-number="20"></a>
<a class="sourceLine" id="cb127-21" data-line-number="21"><span class="co"># Define the g learner, which is a multinomial learner:</span></a>
<a class="sourceLine" id="cb127-22" data-line-number="22"><span class="co"># specify the appropriate loss of the multinomial learner:</span></a>
<a class="sourceLine" id="cb127-23" data-line-number="23">mn_metalearner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_solnp,</a>
<a class="sourceLine" id="cb127-24" data-line-number="24">  <span class="dt">loss_function =</span> loss_loglik_multinomial,</a>
<a class="sourceLine" id="cb127-25" data-line-number="25">  <span class="dt">learner_function =</span> metalearner_linear_multinomial</a>
<a class="sourceLine" id="cb127-26" data-line-number="26">)</a>
<a class="sourceLine" id="cb127-27" data-line-number="27">g_learner &lt;-<span class="st"> </span><span class="kw">make_learner</span>(Lrnr_sl, <span class="kw">list</span>(xgb_learners[[<span class="dv">4</span>]], lrn_mean), mn_metalearner)</a>
<a class="sourceLine" id="cb127-28" data-line-number="28"></a>
<a class="sourceLine" id="cb127-29" data-line-number="29"><span class="co"># Define the Blip learner, which is a multivariate learner:</span></a>
<a class="sourceLine" id="cb127-30" data-line-number="30">learners &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb127-31" data-line-number="31">  xgb_learners[[<span class="dv">1</span>]], xgb_learners[[<span class="dv">2</span>]], xgb_learners[[<span class="dv">3</span>]],</a>
<a class="sourceLine" id="cb127-32" data-line-number="32">  xgb_learners[[<span class="dv">4</span>]], lrn_mean</a>
<a class="sourceLine" id="cb127-33" data-line-number="33">)</a>
<a class="sourceLine" id="cb127-34" data-line-number="34">b_learner &lt;-<span class="st"> </span><span class="kw">create_mv_learners</span>(<span class="dt">learners =</span> learners)</a>
<a class="sourceLine" id="cb127-35" data-line-number="35"></a>
<a class="sourceLine" id="cb127-36" data-line-number="36">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner, <span class="dt">B =</span> b_learner)</a></code></pre></div>
<p>As seen before, we initialize the <code>tmle3_mopttx_blip_revere</code> Spec for question
1. We want to maximize the outcome, the higher the weight-for-height Z-score
the better for children subject to wasting and stunting. We will also use
<code>blip2</code> as the blip type, but note that we could have used <code>blip1</code> as well
since “Control” is a good reference category.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1">## Question 2:</a>
<a class="sourceLine" id="cb128-2" data-line-number="2"></a>
<a class="sourceLine" id="cb128-3" data-line-number="3"><span class="co"># Initialize a tmle specification</span></a>
<a class="sourceLine" id="cb128-4" data-line-number="4">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb128-5" data-line-number="5">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;momedu&quot;</span>, <span class="st">&quot;floor&quot;</span>, <span class="st">&quot;asset_refrig&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb128-6" data-line-number="6">  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb128-7" data-line-number="7">  <span class="dt">realistic =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb128-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb128-9" data-line-number="9"></a>
<a class="sourceLine" id="cb128-10" data-line-number="10"><span class="co"># Fit the TML estimator.</span></a>
<a class="sourceLine" id="cb128-11" data-line-number="11">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, <span class="dt">data =</span> washb_data, node_list, learner_list)</a>
<a class="sourceLine" id="cb128-12" data-line-number="12">fit</a>
<a class="sourceLine" id="cb128-13" data-line-number="13"></a>
<a class="sourceLine" id="cb128-14" data-line-number="14"><span class="co"># Which intervention is the most dominant?</span></a>
<a class="sourceLine" id="cb128-15" data-line-number="15"><span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</a></code></pre></div>
<p>Using the same formulation as before, we estimate the realistic optimal ITR and
the corresponding value of the realistic ITR:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1">## Question 3:</a>
<a class="sourceLine" id="cb129-2" data-line-number="2"></a>
<a class="sourceLine" id="cb129-3" data-line-number="3"><span class="co"># Initialize a tmle specification with &quot;realistic=TRUE&quot;:</span></a>
<a class="sourceLine" id="cb129-4" data-line-number="4">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle3_mopttx_blip_revere</span>(</a>
<a class="sourceLine" id="cb129-5" data-line-number="5">  <span class="dt">V =</span> <span class="kw">c</span>(<span class="st">&quot;momedu&quot;</span>, <span class="st">&quot;floor&quot;</span>, <span class="st">&quot;asset_refrig&quot;</span>), <span class="dt">type =</span> <span class="st">&quot;blip2&quot;</span>,</a>
<a class="sourceLine" id="cb129-6" data-line-number="6">  <span class="dt">learners =</span> learner_list, <span class="dt">maximize =</span> <span class="ot">TRUE</span>, <span class="dt">complex =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb129-7" data-line-number="7">  <span class="dt">realistic =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb129-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb129-9" data-line-number="9"></a>
<a class="sourceLine" id="cb129-10" data-line-number="10"><span class="co"># Fit the TML estimator.</span></a>
<a class="sourceLine" id="cb129-11" data-line-number="11">fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, <span class="dt">data =</span> washb_data, node_list, learner_list)</a>
<a class="sourceLine" id="cb129-12" data-line-number="12">fit</a>
<a class="sourceLine" id="cb129-13" data-line-number="13"></a>
<a class="sourceLine" id="cb129-14" data-line-number="14"><span class="kw">table</span>(tmle_spec<span class="op">$</span>return_rule)</a></code></pre></div>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-cai2019one">
<p>Cai, Weixin, and Mark J van der Laan. 2019. “One-Step Targeted Maximum Likelihood Estimation for Time-to-Event Outcomes.” <em>Biometrics</em>. Wiley Online Library.</p>
</div>
<div id="ref-hubbard2000nonparametric">
<p>Hubbard, Alan E, Mark J Van Der Laan, and James M Robins. 2000. “Nonparametric Locally Efficient Estimation of the Treatment Specific Survival Distribution with Right Censored Data and Covariates in Observational Studies.” In <em>Statistical Models in Epidemiology, the Environment, and Clinical Trials</em>, 135–77. Springer.</p>
</div>
<div id="ref-rotnitzky2014inverse">
<p>Rotnitzky, Andrea, and James M Robins. 2014. “Inverse Probability Weighting in Survival Analysis.” <em>Wiley StatsRef: Statistics Reference Online</em>. Wiley Online Library.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-tmle-framework.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r6.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/deming2019-workshop/edit/master/07-MOSS.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
