<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="generator" content="bookdown 0.16.5 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/deming2019-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  <meta name="github-repo" content="tlverse/deming2019-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 One-Step TMLE for Time-to-Event Outcomes | Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the tlverse Software Ecosystem" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of software materials accompanying an invited half-day tutorial and 2-day short-course at the Deming Conference on Applied Statistics." />
  

<meta name="author" content="Rachael Phillips, Nima Hejazi, Jeremy Coyle, Ivana Malenica, Alan Hubbard, Mark van der Laan" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="the-tmle-framework.html"/>
<link rel="next" href="r6.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Deming Conference 2019 Targeted Learning Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i>Important links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#half-day-tutorial-9a-12p-on-december-4-2019"><i class="fa fa-check"></i>Half-Day Tutorial – 9A-12P on December 4, 2019</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#day-short-course-8a-5p-on-december-5-6-2019"><i class="fa fa-check"></i>2-Day Short Course – 8A-5P on December 5-6, 2019</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contents"><i class="fa fa-check"></i>Contents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors-and-authors"><i class="fa fa-check"></i>About the instructors and authors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="tlverse.html"><a href="tlverse.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="tlverse.html"><a href="tlverse.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="tlverse.html"><a href="tlverse.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="tlverse.html"><a href="tlverse.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="tlverse.html"><a href="tlverse.html#installtlverse"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> The Roadmap of Statistical Learning</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#the-observed-data-and-statistical-model"><i class="fa fa-check"></i><b>2.1</b> The Observed Data and Statistical Model</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>2.2</b> The Causal Model</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>2.3</b> The Parameter of Interest</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>2.4</b> Identifiability</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#estimation-targeted-maximum-likelihood-estimation"><i class="fa fa-check"></i><b>2.5</b> Estimation: Targeted Maximum Likelihood Estimation</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>2.6</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>3</b> Datasets</a><ul>
<li class="chapter" data-level="3.1" data-path="data.html"><a href="data.html#ist"><i class="fa fa-check"></i><b>3.1</b> International Stroke Trial Example Dataset</a></li>
<li class="chapter" data-level="3.2" data-path="data.html"><a href="data.html#wash"><i class="fa fa-check"></i><b>3.2</b> WASH Benefits Example Dataset</a></li>
<li class="chapter" data-level="3.3" data-path="data.html"><a href="data.html#vet"><i class="fa fa-check"></i><b>3.3</b> Veterans’ Administration Lung Cancer Trial Dataset</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html"><i class="fa fa-check"></i><b>4</b> Super (Ensemble Machine) Learning</a><ul>
<li class="chapter" data-level="4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="4.1.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#super-learning"><i class="fa fa-check"></i><b>4.1.1</b> Super Learning</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#review-of-the-super-learner"><i class="fa fa-check"></i>Review of the Super Learner</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3-microwave-dinner-implementation"><i class="fa fa-check"></i><b>4.2</b> <code>sl3</code> “Microwave Dinner” Implementation</a><ul>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#international-stroke-trial-example"><i class="fa fa-check"></i>International Stroke Trial Example</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#load-the-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load the necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#define-the-machine-learning-task"><i class="fa fa-check"></i>1. Define the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#make-a-super-learner"><i class="fa fa-check"></i>2. Make a super learner</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#train-the-super-learner-on-the-machine-learning-task"><i class="fa fa-check"></i>3. Train the super learner on the machine learning task</a></li>
<li class="chapter" data-level="" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#obtain-predicted-values"><i class="fa fa-check"></i>4. Obtain predicted values</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#extensions"><i class="fa fa-check"></i><b>4.3</b> Extensions</a><ul>
<li class="chapter" data-level="4.3.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>4.3.1</b> Cross-validated Super Learner</a></li>
<li class="chapter" data-level="4.3.2" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#variable-importance-measures-with-sl3"><i class="fa fa-check"></i><b>4.3.2</b> Variable Importance Measures with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise"><i class="fa fa-check"></i><b>4.4</b> Exercise</a><ul>
<li class="chapter" data-level="4.4.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#sl3ex"><i class="fa fa-check"></i><b>4.4.1</b> Predicting Myocardial Infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#summary"><i class="fa fa-check"></i><b>4.5</b> Summary</a><ul>
<li class="chapter" data-level="4.5.1" data-path="super-ensemble-machine-learning.html"><a href="super-ensemble-machine-learning.html#exercise-solutions"><i class="fa fa-check"></i><b>4.5.1</b> Exercise Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html"><i class="fa fa-check"></i><b>5</b> The TMLE Framework</a><ul>
<li class="chapter" data-level="5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a><ul>
<li class="chapter" data-level="5.1.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#substitution-estimators"><i class="fa fa-check"></i><b>5.1.1</b> Substitution Estimators</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle"><i class="fa fa-check"></i><b>5.1.2</b> TMLE</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#inference-1"><i class="fa fa-check"></i><b>5.1.3</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#learning-objectives-1"><i class="fa fa-check"></i><b>5.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#easy-bake-example-tmle3-for-ate"><i class="fa fa-check"></i><b>5.3</b> Easy-Bake Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#load-the-data"><i class="fa fa-check"></i>0. Load the Data</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-variable-roles"><i class="fa fa-check"></i>1. Define the variable roles</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#create-a-spec-object"><i class="fa fa-check"></i>2. Create a “Spec” Object</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-relevant-super-learners"><i class="fa fa-check"></i>3. Define the Relevant Super Learners</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit-the-tmle"><i class="fa fa-check"></i>4. Fit the TMLE</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i>5. Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3-components"><i class="fa fa-check"></i><b>5.4</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="5.4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3_task"><i class="fa fa-check"></i><b>5.4.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>5.4.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="5.4.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>5.4.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="5.4.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>5.4.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="5.4.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>5.4.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>5.5</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="5.5.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#delta-method"><i class="fa fa-check"></i><b>5.5.1</b> Delta Method</a></li>
<li class="chapter" data-level="5.5.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit"><i class="fa fa-check"></i><b>5.5.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#stratified-effect-estimates"><i class="fa fa-check"></i><b>5.6</b> Stratified Effect Estimates</a></li>
<li class="chapter" data-level="5.7" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#exercise-1"><i class="fa fa-check"></i><b>5.7</b> Exercise</a></li>
<li class="chapter" data-level="5.8" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#summary-1"><i class="fa fa-check"></i><b>5.8</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html"><i class="fa fa-check"></i><b>6</b> One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="6.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#learning-objectives-2"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#introduction-2"><i class="fa fa-check"></i><b>6.2</b> Introduction</a><ul>
<li class="chapter" data-level="6.2.1" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#existing-methods-for-observational-survival-analysis"><i class="fa fa-check"></i><b>6.2.1</b> Existing Methods for Observational Survival Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#using-moss-for-one-step-tmle-for-time-to-event-outcomes"><i class="fa fa-check"></i><b>6.3</b> Using <code>MOSS</code> for One-Step TMLE for Time-to-Event Outcomes</a><ul>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#load-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#specify-right-censored-survival-data-arguments"><i class="fa fa-check"></i>1. Specify right-censored survival data arguments</a></li>
<li><a href="one-step-tmle-for-time-to-event-outcomes.html#obtain-initial-estimates-with-superlearner-r-package">2. Obtain initial estimates with <code>SuperLearner</code> <code>R</code> package</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#perform-tmle-adjustment-of-the-initial-conditional-survival-estimate"><i class="fa fa-check"></i>3. Perform TMLE adjustment of the initial conditional survival estimate</a></li>
<li class="chapter" data-level="" data-path="one-step-tmle-for-time-to-event-outcomes.html"><a href="one-step-tmle-for-time-to-event-outcomes.html#compute-standard-error-estimates-for-simultaneous-inference"><i class="fa fa-check"></i>4. Compute standard error estimates for simultaneous inference</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>7</b> A Primer on the <code>R6</code> Class System</a><ul>
<li class="chapter" data-level="7.1" data-path="r6.html"><a href="r6.html#classes-fields-and-methods"><i class="fa fa-check"></i><b>7.1</b> Classes, Fields, and Methods</a></li>
<li class="chapter" data-level="7.2" data-path="r6.html"><a href="r6.html#object-oriented-programming-python-and-r"><i class="fa fa-check"></i><b>7.2</b> Object Oriented Programming: <code>Python</code> and <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Targeted (Machine) Learning for Real-World Data Science and Causal Inference with the <code>tlverse</code> Software Ecosystem</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="one-step-tmle-for-time-to-event-outcomes" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> One-Step TMLE for Time-to-Event Outcomes</h1>
<p>Based on the <a href="https://github.com/wilsoncai1992/MOSS"><code>MOSS</code> <code>R</code> package</a>
by <em>Wilson Cai and Mark van der Laan</em>.</p>
<p>Updated: 2019-12-06</p>
<div id="learning-objectives-2" class="section level2">
<h2><span class="header-section-number">6.1</span> Learning Objectives</h2>
<ol style="list-style-type: decimal">
<li>Format right-censored survival data for <code>MOSS</code>.</li>
<li>Fit a SuperLearner initial estimate of the conditional survival function of
failure, conditional survival function of censoring and the propensity scores
(<code>initial_sl_fit</code>).</li>
<li>Calculate the TMLE adjustment of the conditional survival fit
(<code>MOSS_hazard</code>).</li>
<li>Formulate a simultaneous confidence band for the estimated conditional
survival across a range of time-points (<code>compute_simultaneous_ci</code>).</li>
</ol>
</div>
<div id="introduction-2" class="section level2">
<h2><span class="header-section-number">6.2</span> Introduction</h2>
<p>In this section, we explore the <code>MOSS</code> <code>R</code> package. This software performs
ensemble machine learning with the <a href="https://cran.r-project.org/web/packages/SuperLearner/index.html"><code>SuperLearner</code> <code>R</code>
package</a> and
One-Step Targeted Maximum Likelihood Estimation (TMLE) to estimate
counterfactual marginal survival functions and the Average Treatment Effect
(ATE) on survival probabilities, while non-parametrically adjusting for measured
confounding. This one-step TMLE can be executed via recursion in small local
updates, and creates a doubly robust and semi-parametrically efficient
estimator. Simultaneous confidence bands of the entire curve are also
available for inference.</p>
<div id="existing-methods-for-observational-survival-analysis" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Existing Methods for Observational Survival Analysis</h3>
<p>To facilitate comparison with other estimation procedures, the following
additional estimators are also included in the <code>MOSS</code> <code>R</code> package:</p>
<ul>
<li>Inverse Censoring Probability Weighted (IPCW) estimator, which re-weights the
observed data by the inverse of the product of the propensity score and
censoring probability before applying a standard estimation method
<span class="citation">(Rotnitzky and Robins <a href="#ref-rotnitzky2014inverse">2014</a>)</span>.</li>
<li>Estimating Equation (EE) estimator, which improves IPCW by adding the sample
mean of the efficient influence curve and is a locally efficient and double
robust <span class="citation">(Hubbard, Van Der Laan, and Robins <a href="#ref-hubbard2000nonparametric">2000</a>)</span>.</li>
</ul>
<p><strong>TMLE works well to improve the statistical efficiency of EE</strong>
Like EE, TMLE is also doubly robust and locally efficient. In contrast to these
two methods, TMLE performs an adjustment on the estimate of the relevant part
of the data-generating distribution before applying the parameter mapping and
thus always respects the parameter space (probabilities falling inside [0,1]),
a so-called substitution/plug-in estimator. As a result, is more robust to
outliers and sparsity than non-substitution estimators.</p>
<p><strong>Motivating one-step TMLE: monotonic survival curve</strong>
EE and TMLE utilize efficiency theory derived for univariate parameters, making
estimation of the survival curve a collection of univariate survival probability
estimators. This procedure can lead to a survival curve that is not
monotonically decreasing. The one-step TMLE implemented in <code>MOSS</code> targets the
survival curve <em>as a whole</em> and thus ensures monotonicity, while preserving the
desirable performance of the point-wise TMLE <span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>.</p>
</div>
</div>
<div id="using-moss-for-one-step-tmle-for-time-to-event-outcomes" class="section level2">
<h2><span class="header-section-number">6.3</span> Using <code>MOSS</code> for One-Step TMLE for Time-to-Event Outcomes</h2>
<p><code>MOSS</code> implementation consists of the following steps:</p>
<ol start="0" style="list-style-type: decimal">
<li>Load the necessary libraries and data.</li>
<li>Specify the right-censored survival data arguments.</li>
<li>Estimate the (1) conditional survival function of failure event, (2)
conditional survival function of censoring event, and (3) propensity score
with the <code>SuperLearner</code> <code>R</code> package.</li>
<li>Perform TMLE adjustment of the initial conditional survival fit.</li>
<li>Compute standard error estimates for simultaneous inference.</li>
</ol>
<div id="load-necessary-libraries-and-data" class="section level3 unnumbered">
<h3>0. Load necessary libraries and data</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="kw">library</span>(MOSS)</a>
<a class="sourceLine" id="cb77-2" data-line-number="2"></a>
<a class="sourceLine" id="cb77-3" data-line-number="3">vet_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/deming2019-workshop/master/data/veteran.csv&quot;</span>)</a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="kw">head</span>(vet_data)</a></code></pre></div>
<pre><code>  X trt celltype time status karno diagtime age prior
1 1   1 squamous   72      1    60        7  69     0
2 2   1 squamous  411      1    70        5  64    10
3 3   1 squamous  228      1    60        3  38     0
4 4   1 squamous  126      1    60        9  63    10
5 5   1 squamous  118      1    70       11  65    10
6 6   1 squamous   10      1    20        5  49     0</code></pre>
<p>The variables in <code>vet_data</code> are
* <code>trt</code>: treatment type (1 = standard, 2 = test),
* <code>celltype</code>: histological type of the tumor,
* <code>time</code>: time to death or censoring in days,
* <code>status</code>: censoring status,
* <code>karno</code>: Karnofsky performance score that describes overall patient status at
the beginning of the study (100 = good),
* <code>diagtime</code>: months from diagnosis to randomization,
* <code>age</code>: age of patient in years, and
* <code>prior</code>: prior therapy (0 = no, 10 = yes).</p>
</div>
<div id="specify-right-censored-survival-data-arguments" class="section level3 unnumbered">
<h3>1. Specify right-censored survival data arguments</h3>
<p>The following variables need to be specified from the data so they can
subsequently be used as required arguments for <code>MOSS</code> functions:</p>
<ul>
<li><code>W</code>: dataframe of baseline covariates <span class="math inline">\(W\)</span>.</li>
<li><code>A</code>: binary treatment vector <span class="math inline">\(A\)</span>.</li>
<li><code>T_tilde</code>: time-to-event vector <span class="math inline">\(\tilde{T} = \min(T, C)\)</span>.</li>
<li><code>Delta</code>: censoring indicator vector <span class="math inline">\(\Delta = I(T \leq C)\)</span>.</li>
<li><code>t_max</code>: the maximum time to estimate the survival probabilities.</li>
</ul>
<p>We can specify these variables with our observed <code>vet_data</code>.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">T_tilde &lt;-<span class="st"> </span>vet_data<span class="op">$</span>time</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">Delta &lt;-<span class="st"> </span>vet_data<span class="op">$</span>status</a>
<a class="sourceLine" id="cb79-3" data-line-number="3">A &lt;-<span class="st"> </span>vet_data<span class="op">$</span>trt</a>
<a class="sourceLine" id="cb79-4" data-line-number="4">W &lt;-<span class="st"> </span>vet_data[, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">6</span><span class="op">:</span><span class="dv">9</span>)]</a>
<a class="sourceLine" id="cb79-5" data-line-number="5">t_max &lt;-<span class="st"> </span><span class="kw">max</span>(T_tilde)</a></code></pre></div>
</div>
<div id="obtain-initial-estimates-with-superlearner-r-package" class="section level3 unnumbered">
<h3>2. Obtain initial estimates with <code>SuperLearner</code> <code>R</code> package</h3>
<p>We will use the <code>initial_sl_fit()</code> function to specify the data (as we
defined it above) and the <code>SuperLearner</code> library for initial estimation of each
of the following components of the likelihood:</p>
<ol style="list-style-type: decimal">
<li>conditional survival function of failure event given treatment and
confounders,</li>
<li>conditional survival function for censoring event given treatment and
confounders, and</li>
<li>propensity score of treatment given confounders.</li>
</ol>
<p>We are forgetting one component of the likelihood that requires estimation: the
joint distribution of confounders! In <code>MOSS</code> this estimation is done for us
under the hood, and we do not use the <code>SuperLearner</code>. Do you recall why we do
not use the <code>SuperLearner</code> to estimate the joint distribution of confounders
nonparametrically?</p>
<p>The conditional survival functions are estimated by first estimating the
conditional hazard, and then transforming into the conditional survival
function. For a thorough explanation of these procedure see Section 3 from
<span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>. Currently, <code>MOSS</code> requires the user to do this one-to-one
tranformation from the conditional hazard to the conditional survival
probabilities by calling the <code>hazard_to_survival()</code> method. We will address
this later on.</p>
<p>Back to <code>initial_sl_fit()</code> – we have the option to specify the following
arguments in addition to the required data arguments.</p>
<ul>
<li><code>sl_failure</code>: SuperLearner library for failure event hazard, default =
c(“SL.glm”)</li>
<li><code>sl_censoring</code>: SuperLearner library for censoring event hazard, default =
c(“SL.glm”)</li>
<li><code>sl_treatment</code>: SuperLearner library for propensity score, default =
c(“SL.glm”)</li>
<li><code>gtol</code>: treshold for truncating propensity scores, default = 0.001)</li>
</ul>
<p>It is highly recommended that you specify a more complex library than the
default. The SuperLearner library arguments take a vector of strings
corresponding to learners available in the <code>SuperLearner</code> <code>R</code> package:
<a href="https://github.com/ecpolley/SuperLearner/tree/master/R" class="uri">https://github.com/ecpolley/SuperLearner/tree/master/R</a>.</p>
<p>We do not review the <code>SuperLearner</code> <code>R</code> package in these workshops, but a handy
tutorial crafted a few years ago by our colleague Chris Kennedy is freely
available: <a href="https://cran.r-project.org/web/packages/SuperLearner/vignettes/Guide-to-SuperLearner.html">Guide to
SuperLearner</a>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co"># recall treatment was randomized</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2">SL.ranger.faster =<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">  <span class="kw">SL.ranger</span>(..., <span class="dt">num.trees =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb80-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb80-5" data-line-number="5">sl_lib_decent &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SL.mean&quot;</span>, <span class="st">&quot;SL.glm&quot;</span>, <span class="st">&quot;SL.step.forward&quot;</span>, <span class="st">&quot;SL.bayesglm&quot;</span>, </a>
<a class="sourceLine" id="cb80-6" data-line-number="6">                   <span class="st">&quot;SL.ranger.faster&quot;</span>, <span class="st">&quot;SL.gam&quot;</span>)</a>
<a class="sourceLine" id="cb80-7" data-line-number="7"></a>
<a class="sourceLine" id="cb80-8" data-line-number="8">initial_fit &lt;-<span class="st"> </span><span class="kw">initial_sl_fit</span>(T_tilde, Delta, A, W, t_max, </a>
<a class="sourceLine" id="cb80-9" data-line-number="9">                              <span class="dt">sl_censoring =</span> sl_lib_decent, </a>
<a class="sourceLine" id="cb80-10" data-line-number="10">                              <span class="dt">sl_failure =</span> sl_lib_decent)</a>
<a class="sourceLine" id="cb80-11" data-line-number="11"></a>
<a class="sourceLine" id="cb80-12" data-line-number="12"><span class="kw">names</span>(initial_fit)</a></code></pre></div>
<pre><code>[1] &quot;density_failure_1&quot; &quot;density_failure_0&quot; &quot;density_censor_1&quot; 
[4] &quot;density_censor_0&quot;  &quot;g1W&quot;              </code></pre>
<p>The <code>initial_fit</code> object contains the fitted conditional densities for the
failure events (<code>density_failure_1</code> for test treatment group,
<code>density_failure_0</code> for standard treatment group), censoring events
(<code>density_censor_1</code> and <code>density_censor_0</code> for test treatment and standard
treatment groups, respectively), and propensity scores (a vector <code>g1W</code>).</p>
<p>The <code>density_failure_1</code> and <code>density_failure_0</code> both need to go through the
<code>hazard_to_survival</code> method which populates the <code>survival</code> attribute of the
object.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span><span class="op">$</span><span class="kw">hazard_to_survival</span>()</a></code></pre></div>
<pre><code>&lt;survival_curve&gt;
  Public:
    ci: function (A, T_tilde, Delta, density_failure, density_censor, 
    clone: function (deep = FALSE) 
    create_ggplot_df: function (W = NULL) 
    display: function (type, W = NULL) 
    hazard: 0.00913095238511278 0.00733923669106901 0.00905979449151 ...
    hazard_to_pdf: function () 
    hazard_to_survival: function () 
    initialize: function (t, hazard = NULL, survival = NULL, pdf = NULL) 
    n: function () 
    pdf: NULL
    pdf_to_hazard: function () 
    pdf_to_survival: function () 
    survival: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  ...
    survival_to_hazard: function () 
    survival_to_pdf: function () 
    t: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ...</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span><span class="op">$</span><span class="kw">hazard_to_survival</span>()</a></code></pre></div>
<pre><code>&lt;survival_curve&gt;
  Public:
    ci: function (A, T_tilde, Delta, density_failure, density_censor, 
    clone: function (deep = FALSE) 
    create_ggplot_df: function (W = NULL) 
    display: function (type, W = NULL) 
    hazard: 0.00913095238511278 0.00733923669106901 0.00905979449151 ...
    hazard_to_pdf: function () 
    hazard_to_survival: function () 
    initialize: function (t, hazard = NULL, survival = NULL, pdf = NULL) 
    n: function () 
    pdf: NULL
    pdf_to_hazard: function () 
    pdf_to_survival: function () 
    survival: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1  ...
    survival_to_hazard: function () 
    survival_to_pdf: function () 
    t: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ...</code></pre>
</div>
<div id="perform-tmle-adjustment-of-the-initial-conditional-survival-estimate" class="section level3 unnumbered">
<h3>3. Perform TMLE adjustment of the initial conditional survival estimate</h3>
<p>The one-step TMLE is carried out by many local least favorable submodels (LLFMs)
(performed via logistic regressions) with small step sizes. The one-step TMLE
updates in small steps locally along LLFM, ensuring that the direction of the
update is optimal around the current probability density. This procedure
permits updates to the conditional hazard for all points on the survival curve
(or any high-dimensional parameter in general), so that the conditional hazard
can be transformed into a monotone survival curve after the algorithm.</p>
<p>At this point we are nearly ready to update the hazard using this constrained
step size update. The only additional argument we need to define is</p>
<ul>
<li><code>k_grid</code>: the vector of interested time points for estimation of the
conditional survival probability.</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">k_grid &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">max</span>(T_tilde)</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span><span class="op">$</span>t &lt;-<span class="st"> </span>k_grid</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span><span class="op">$</span>t &lt;-<span class="st"> </span>k_grid</a></code></pre></div>
<p>We perform the TMLE adjustment of the initial conditional survival estimate by
first creating a <code>MOSS_hazard</code> or <code>MOSS_hazard_ate</code> object and then calling
the <code>iterate_onestep()</code> method for this object. <code>MOSS_hazard</code> and
<code>MOSS_hazard_ate</code> correspond to different estimators:</p>
<ul>
<li><code>MOSS_hazard</code>: one-step TMLE of the treatment-specific survival curve, and</li>
<li><code>MOSS_hazard_ate</code>: one-step TMLE of ATE on survival probabilities</li>
</ul>
<p><strong>One-step TMLE of the Treatment-Specific Survival</strong></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="co"># estimate survival curve for standard treatment group</span></a>
<a class="sourceLine" id="cb87-2" data-line-number="2">hazard_fit_standardA &lt;-<span class="st"> </span>MOSS_hazard<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb87-3" data-line-number="3">  A,</a>
<a class="sourceLine" id="cb87-4" data-line-number="4">  T_tilde,</a>
<a class="sourceLine" id="cb87-5" data-line-number="5">  Delta,</a>
<a class="sourceLine" id="cb87-6" data-line-number="6">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb87-7" data-line-number="7">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb87-8" data-line-number="8">  <span class="dt">g1W =</span> initial_fit<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb87-9" data-line-number="9">  <span class="dt">A_intervene =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb87-10" data-line-number="10">  k_grid</a>
<a class="sourceLine" id="cb87-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb87-12" data-line-number="12">psi_standardA &lt;-<span class="st"> </span>hazard_fit_standardA<span class="op">$</span><span class="kw">iterate_onestep</span>()</a></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="co"># estimate survival curve for test treatment group</span></a>
<a class="sourceLine" id="cb88-2" data-line-number="2">hazard_fit_testA &lt;-<span class="st"> </span>MOSS_hazard<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb88-3" data-line-number="3">  A,</a>
<a class="sourceLine" id="cb88-4" data-line-number="4">  T_tilde,</a>
<a class="sourceLine" id="cb88-5" data-line-number="5">  Delta,</a>
<a class="sourceLine" id="cb88-6" data-line-number="6">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb88-7" data-line-number="7">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb88-8" data-line-number="8">  <span class="dt">g1W =</span> initial_fit<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb88-9" data-line-number="9">  <span class="dt">A_intervene =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb88-10" data-line-number="10">  k_grid</a>
<a class="sourceLine" id="cb88-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb88-12" data-line-number="12">psi_testA &lt;-<span class="st"> </span>hazard_fit_testA<span class="op">$</span><span class="kw">iterate_onestep</span>()</a></code></pre></div>
<p><strong>One-step TMLE of ATE on Survival</strong></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">hazard_fit_ate &lt;-<span class="st"> </span>MOSS_hazard_ate<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb89-2" data-line-number="2">  A,</a>
<a class="sourceLine" id="cb89-3" data-line-number="3">  T_tilde,</a>
<a class="sourceLine" id="cb89-4" data-line-number="4">  Delta,</a>
<a class="sourceLine" id="cb89-5" data-line-number="5">  <span class="dt">density_failure =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb89-6" data-line-number="6">  <span class="dt">density_censor =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb89-7" data-line-number="7">  <span class="dt">density_failure_0 =</span> initial_fit<span class="op">$</span>density_failure_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb89-8" data-line-number="8">  <span class="dt">density_censor_0 =</span> initial_fit<span class="op">$</span>density_censor_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb89-9" data-line-number="9">  initial_fit<span class="op">$</span>g1W</a>
<a class="sourceLine" id="cb89-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb89-11" data-line-number="11">psi_ate &lt;-<span class="st"> </span>hazard_fit_ate<span class="op">$</span><span class="kw">iterate_onestep</span>()</a>
<a class="sourceLine" id="cb89-12" data-line-number="12"><span class="kw">summary</span>(psi_ate)</a></code></pre></div>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0 </code></pre>
</div>
<div id="compute-standard-error-estimates-for-simultaneous-inference" class="section level3 unnumbered">
<h3>4. Compute standard error estimates for simultaneous inference</h3>
<p>After creating a vector of survival curve estimates by defining a new
<code>survival_curve</code> object, we will estimate the efficient influence curve
using the TML-estimates generated in the previous step and then generate a
simultaneous confidence band for the TML-estimates.</p>
<p>A simultaneous confidence interval achieves the desired coverage across many
points, unlike the traditional confidence interval which achieves the desired
coverage for one point. Thus, the standard error for simultaneous inference is
larger when demanding simultaneous coverage of the truth, and it directly
follows that simultaneous confidence intervals are wider. Simultaneous inference
is a multiple testing procedure which controls the family-wise error rate.</p>
<p>A 95% simultaneous confidence band for the TML-estimates is constructed in the
following manner:</p>
<ol style="list-style-type: decimal">
<li>Retain the TML-estimates of the probability of surviving up to or past each
time specified in <code>k_grid</code> that we generated in the previous step.</li>
<li>Compute the influence curve matrix for all times specified in <code>k_grid</code> using
these TMLEs, where each column is an a time in <code>k_grid</code> and each row
corresponds to a subject.</li>
<li>Calculate the correlation of the IC matrix.</li>
<li>Randomly draw many values from a multivariate Normal(0,Sigma) distribution
(e.g. <code>z &lt;- rmvnorm(1e6, mean = rep(0, length(k_grid)), sigma = cor(IC_matrix))</code>
), where sigma corresponds to what was generated in step 3.</li>
<li>Identify the row-wise maximum of the absolute value of each MVN value (e.g.
<code>z_abs &lt;-  apply(z, 1, function(x) max(abs(x)))</code>).</li>
<li>Using these maximum absolute values, calculate the 95th quantile of <code>z_abs</code>,
which is the standard error to use for simultaneous inference
(e.g. <code>z_95 &lt;- quantile(z_abs, .95)</code>)</li>
<li>Calculate the time-specific standard deviation of the influence functions
(e.g. <code>sd_IC_time1 &lt;- sd(IC_matrix[,1])*sqrt(n-1)/n</code>)</li>
<li>Calculate the time-specific simultaneous confidence intervals (e.g.
<code>lower_bound_time1 &lt;- est_time1 - z_95*sd_IC_time1</code>)</li>
</ol>
<p>The simultaneous inference for the TML-estimates are constructed based on
asymptotic linearity of the TMLE uniform in all points considered. Step 4
approximates the Guassian process, and step 5 calculates the supremum norm of
this process. The 0.95 quantile of the supremum norm of the Guassian process
calculated in step 6 (i.e. <code>z_95</code>) will converge as the sample size increases
and as the values drawn from the MVN (i.e. <code>1e6</code> used in step 4) increase.</p>
<p>See the manuscript accompanying the <code>MOSS</code> package for more details and
references on constructing simultaneous inference <span class="citation">(Cai and Laan <a href="#ref-cai2019one">2019</a>)</span>.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="co"># estimate and obtain inference for survival curve for standard treatment group</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2">survival_standardA &lt;-<span class="st"> </span>survival_curve<span class="op">$</span><span class="kw">new</span>(<span class="dt">t =</span> k_grid, <span class="dt">survival =</span> psi_standardA)</a>
<a class="sourceLine" id="cb91-3" data-line-number="3">survival_curve_standardA &lt;-<span class="st"> </span><span class="kw">as.vector</span>(survival_standardA<span class="op">$</span>survival)</a>
<a class="sourceLine" id="cb91-4" data-line-number="4"></a>
<a class="sourceLine" id="cb91-5" data-line-number="5">eic_standardA &lt;-<span class="st"> </span>eic<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb91-6" data-line-number="6">  <span class="dt">A =</span> A,</a>
<a class="sourceLine" id="cb91-7" data-line-number="7">  <span class="dt">T_tilde =</span> T_tilde,</a>
<a class="sourceLine" id="cb91-8" data-line-number="8">  <span class="dt">Delta =</span> Delta,</a>
<a class="sourceLine" id="cb91-9" data-line-number="9">  <span class="dt">density_failure =</span> hazard_fit_standardA<span class="op">$</span>density_failure,</a>
<a class="sourceLine" id="cb91-10" data-line-number="10">  <span class="dt">density_censor =</span> hazard_fit_standardA<span class="op">$</span>density_censor,</a>
<a class="sourceLine" id="cb91-11" data-line-number="11">  <span class="dt">g1W =</span> hazard_fit_standardA<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb91-12" data-line-number="12">  <span class="dt">psi =</span> survival_curve_standardA,</a>
<a class="sourceLine" id="cb91-13" data-line-number="13">  <span class="dt">A_intervene =</span> hazard_fit_standardA<span class="op">$</span>A_intervene</a>
<a class="sourceLine" id="cb91-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb91-15" data-line-number="15">eic_matrix_standardA &lt;-<span class="st"> </span>eic_standardA<span class="op">$</span><span class="kw">all_t</span>(<span class="dt">k_grid =</span> k_grid)</a>
<a class="sourceLine" id="cb91-16" data-line-number="16">std_err_standardA &lt;-<span class="st"> </span><span class="kw">compute_simultaneous_ci</span>(eic_matrix_standardA)</a>
<a class="sourceLine" id="cb91-17" data-line-number="17">upper_bound_standardA &lt;-<span class="st"> </span>survival_curve_standardA <span class="op">+</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_standardA)</a>
<a class="sourceLine" id="cb91-18" data-line-number="18">lower_bound_standardA &lt;-<span class="st"> </span>survival_curve_standardA <span class="op">-</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_standardA)</a>
<a class="sourceLine" id="cb91-19" data-line-number="19"></a>
<a class="sourceLine" id="cb91-20" data-line-number="20">plotdf_standardA &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> k_grid, <span class="dt">est =</span> survival_curve_standardA, </a>
<a class="sourceLine" id="cb91-21" data-line-number="21">                               <span class="dt">upper =</span> upper_bound_standardA, </a>
<a class="sourceLine" id="cb91-22" data-line-number="22">                               <span class="dt">lower =</span> lower_bound_standardA, </a>
<a class="sourceLine" id="cb91-23" data-line-number="23">                               <span class="dt">type =</span> <span class="kw">rep</span>(<span class="st">&quot;standard&quot;</span>, <span class="kw">length</span>(k_grid)))</a>
<a class="sourceLine" id="cb91-24" data-line-number="24"></a>
<a class="sourceLine" id="cb91-25" data-line-number="25">plot_standardA &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> plotdf_standardA, <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> est)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb91-27" data-line-number="27"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> plotdf_standardA, <span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), </a>
<a class="sourceLine" id="cb91-28" data-line-number="28">              <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb91-29" data-line-number="29"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Treatment-Specific Survival Curves Among Standard Treatment Group in</span></a>
<a class="sourceLine" id="cb91-30" data-line-number="30"><span class="st">           Veterans’ Administration Lung Cancer Trial&quot;</span>)</a>
<a class="sourceLine" id="cb91-31" data-line-number="31">plot_standardA</a></code></pre></div>
<p><img src="deming2019_workshop_files/figure-html/moss-4-standard-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="co"># estimate and obtain inference for survival curve for test treatment group</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2">survival_testA &lt;-<span class="st"> </span>survival_curve<span class="op">$</span><span class="kw">new</span>(<span class="dt">t =</span> k_grid, <span class="dt">survival =</span> psi_testA)</a>
<a class="sourceLine" id="cb92-3" data-line-number="3">survival_curve_testA &lt;-<span class="st"> </span><span class="kw">as.vector</span>(survival_testA<span class="op">$</span>survival)</a>
<a class="sourceLine" id="cb92-4" data-line-number="4"></a>
<a class="sourceLine" id="cb92-5" data-line-number="5">eic_testA &lt;-<span class="st"> </span>eic<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb92-6" data-line-number="6">  <span class="dt">A =</span> A,</a>
<a class="sourceLine" id="cb92-7" data-line-number="7">  <span class="dt">T_tilde =</span> T_tilde,</a>
<a class="sourceLine" id="cb92-8" data-line-number="8">  <span class="dt">Delta =</span> Delta,</a>
<a class="sourceLine" id="cb92-9" data-line-number="9">  <span class="dt">density_failure =</span> hazard_fit_testA<span class="op">$</span>density_failure,</a>
<a class="sourceLine" id="cb92-10" data-line-number="10">  <span class="dt">density_censor =</span> hazard_fit_testA<span class="op">$</span>density_censor,</a>
<a class="sourceLine" id="cb92-11" data-line-number="11">  <span class="dt">g1W =</span> hazard_fit_testA<span class="op">$</span>g1W,</a>
<a class="sourceLine" id="cb92-12" data-line-number="12">  <span class="dt">psi =</span> survival_curve_testA,</a>
<a class="sourceLine" id="cb92-13" data-line-number="13">  <span class="dt">A_intervene =</span> hazard_fit_testA<span class="op">$</span>A_intervene</a>
<a class="sourceLine" id="cb92-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb92-15" data-line-number="15">eic_matrix_testA &lt;-<span class="st"> </span>eic_testA<span class="op">$</span><span class="kw">all_t</span>(<span class="dt">k_grid =</span> k_grid)</a>
<a class="sourceLine" id="cb92-16" data-line-number="16">std_err_testA &lt;-<span class="st"> </span><span class="kw">compute_simultaneous_ci</span>(eic_matrix_testA)</a>
<a class="sourceLine" id="cb92-17" data-line-number="17">upper_bound_testA &lt;-<span class="st"> </span>survival_curve_testA <span class="op">+</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_testA)</a>
<a class="sourceLine" id="cb92-18" data-line-number="18">lower_bound_testA &lt;-<span class="st"> </span>survival_curve_testA <span class="op">-</span><span class="st"> </span>(<span class="fl">1.96</span><span class="op">*</span>std_err_testA)</a>
<a class="sourceLine" id="cb92-19" data-line-number="19"></a>
<a class="sourceLine" id="cb92-20" data-line-number="20">plotdf_testA &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">time =</span> k_grid, <span class="dt">est =</span> survival_curve_testA, </a>
<a class="sourceLine" id="cb92-21" data-line-number="21">                           <span class="dt">upper =</span> upper_bound_testA, <span class="dt">lower =</span> lower_bound_testA, </a>
<a class="sourceLine" id="cb92-22" data-line-number="22">                           <span class="dt">type =</span> <span class="kw">rep</span>(<span class="st">&quot;test&quot;</span>, <span class="kw">length</span>(k_grid)))</a>
<a class="sourceLine" id="cb92-23" data-line-number="23"></a>
<a class="sourceLine" id="cb92-24" data-line-number="24">plot_testA &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> plotdf_testA, <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> est)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-25" data-line-number="25"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb92-26" data-line-number="26"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> plotdf_testA, <span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb92-27" data-line-number="27"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Treatment-Specific Survival Curves Among Test Treatment Group in</span></a>
<a class="sourceLine" id="cb92-28" data-line-number="28"><span class="st">           Veterans’ Administration Lung Cancer Trial&quot;</span>)</a>
<a class="sourceLine" id="cb92-29" data-line-number="29">plot_testA</a></code></pre></div>
<p><img src="deming2019_workshop_files/figure-html/moss-4-test-1.png" width="70%" style="display: block; margin: auto;" /></p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-cai2019one">
<p>Cai, Weixin, and Mark J van der Laan. 2019. “One-Step Targeted Maximum Likelihood Estimation for Time-to-Event Outcomes.” <em>Biometrics</em>. Wiley Online Library.</p>
</div>
<div id="ref-hubbard2000nonparametric">
<p>Hubbard, Alan E, Mark J Van Der Laan, and James M Robins. 2000. “Nonparametric Locally Efficient Estimation of the Treatment Specific Survival Distribution with Right Censored Data and Covariates in Observational Studies.” In <em>Statistical Models in Epidemiology, the Environment, and Clinical Trials</em>, 135–77. Springer.</p>
</div>
<div id="ref-rotnitzky2014inverse">
<p>Rotnitzky, Andrea, and James M Robins. 2014. “Inverse Probability Weighting in Survival Analysis.” <em>Wiley StatsRef: Statistics Reference Online</em>. Wiley Online Library.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-tmle-framework.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r6.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/deming2019-workshop/edit/master/07-MOSS.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
